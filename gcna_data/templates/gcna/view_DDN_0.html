{% extends 'gcna/base.html' %}



{% block content%}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Dispatched Dried Nutmeg Records</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Raleway', sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
        }

        .header-container {
            background-color: #e4e4e4;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 25px rgba(0, 0, 0, 0.2);
        }

        .record-card {
            background-color: #ffffff;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .record-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: #f1f1f1;
            padding: 15px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        .badge-mace {
            background-color: #28a745;
            color: white;
        }

        .badge-dried {
            background-color: #007bff;
            color: white;
        }

        .badge-green {
            background-color: #17a2b8;
            color: white;
        }

        .form-header {
            background-color: #f1f1f1;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .filter-section {
            background-color: #ffffff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .table-responsive {
            margin-top: 10px;
        }

        .table th {
            background-color: #f8f9fa;
        }

        .no-records {
            text-align: center;
            padding: 50px;
            background-color: #ffffff;
            border-radius: 8px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .detail-row {
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: bold;
        }

        .batch-code {
            background-color: #f8f9fa;
            padding: 3px 8px;
            border-radius: 4px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
            font-family: monospace;
        }

        .collapse-toggle {
            cursor: pointer;
            color: #007bff;
        }

        .collapse-toggle:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-container">
            <div class="form-header">
                <h6>Document No. GCNA-GMP</h6>
                <h6>Document Title: View Dispatched Dried Nutmeg Records</h6>
                <h6>Date: <span id="current-date"></span></h6>
                <h6>Version: 1.0</h6>
            </div>

            <h1 class="text-center mb-4">Dispatched Dried Nutmeg Records</h1>

            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="filterStation" class="form-label">Filter by Station</label>
                        <select class="form-select" id="filterStation">
                            <option value="">All Stations</option>
                            <option value="G">Grenville</option>
                            <option value="H">Hermitage</option>
                            <option value="M">Marli</option>
                            <option value="U">Union</option>
                            <option value="GP">Gouyave</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filterFormType" class="form-label">Filter by Form Type</label>
                        <select class="form-select" id="filterFormType">
                            <option value="">All Forms</option>
                            <option value="mace">Mace</option>
                            <option value="dried">Dried</option>
                            <option value="green">Green</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="searchBatchCode" class="form-label">Search Batch Code</label>
                        <input type="text" class="form-control" id="searchBatchCode" placeholder="Enter batch code...">
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <button id="applyFilters" class="btn btn-primary me-2">Apply Filters</button>
                        <button id="resetFilters" class="btn btn-secondary">Reset Filters</button>
                        <button id="syncButton" class="btn btn-danger">
                            Check External
                        </button>

                        <button id="syncButtonChange" class="btn btn-danger">
                            View External
                        </button>
                    </div>
                </div>
            </div>

            <!-- Records Display -->
            <div id="recordsContainer">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading records...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <nav aria-label="Page navigation">
                    <ul class="pagination" id="pagination">
                        <!-- Pagination will be generated dynamically -->
                    </ul>
                </nav>
            </div>

            <!-- Back Button -->
            <div class="text-center mt-4 mb-3">
                <a href="/table/" class="btn btn-secondary">Back to Form</a>
            </div>
        </div>
    </div>



    <!-- 
<script type="module"> // Ensure type="module" is used for Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, set, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
    apiKey: "AIzaSyBZTB_mN_gIb6mqeM8nid4x83oKRehmFKo",
    authDomain: "farmer-project-sync.firebaseapp.com",
    databaseURL: "https://farmer-project-sync-default-rtdb.firebaseio.com",
    projectId: "farmer-project-sync",
    storageBucket: "farmer-project-sync.firebasestorage.app",
    messagingSenderId: "1366353203",
    appId: "1:1366353203:web:fa29fd29cc326a0d63ca46"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    
    const DISPATCH_STORE = "Dispatch-Of-Dried-Nutmeg";
    const stations = ["Grenville", "Hermitage", "Marli", "Union", "Gouyave", "Victoria"];

    // --- EVENT LISTENER ---
    document.getElementById('syncButton').addEventListener('click', async () => {
        const btn = document.getElementById('syncButton');
        btn.disabled = true;
        btn.innerText = "Collecting...";
        
        console.log('Starting Sync Process...');
        await handleStationArray();
        
        btn.disabled = false;
        btn.innerText = "Dispatch Data Collection";
        alert("Collection Complete!");
    });

    async function handleStationArray() {
        for (const station of stations) {
            await getExtStationData(station);
        }
    }

    async function getExtStationData(stationName) {
        const existingStation = await findStation(stationName);
        if (existingStation) {
            // Passing the Station ID found in Firebase to load specific model data
            await loadDataFromFirebase(existingStation.StationId);
        } else {
            console.log(`${stationName} not yet created in Firebase`);
        }
    }

    async function loadDataFromFirebase(stationId) {
        console.log(`Loading data for Station ID: ${stationId}`);
        // Pointing to the specific model store you defined
        const userRef = ref(db, `Users/${stationId}/models/${DISPATCH_STORE}`);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            const modelData = snapshot.val();
            await loadModelToIndexedDB(DISPATCH_STORE, modelData);
            console.log(`Data for ${DISPATCH_STORE} successfully loaded.`);
        } else {
            console.log(`No ${DISPATCH_STORE} data found for this station.`);
        }
    }

    async function loadModelToIndexedDB(modelName, modelData) {
        const idb = await initializeIndexedDB();
        const transaction = idb.transaction(modelName, "readwrite");
        const store = transaction.objectStore(modelName);

        // Convert object to array if Firebase returns an object-map
        const items = Array.isArray(modelData) ? modelData : Object.values(modelData);

        for (const item of items) {
            if (!item || item.id == null) continue;

            let newItem = { ...item };
            // Ensure unique ID to prevent IndexedDB ConstraintError
            while (await idExists(store, newItem.id)) {
                newItem.id = Number(newItem.id) + 1;
            }
            store.put(newItem);
        }
    }

    // --- HELPER FUNCTIONS ---

    function initializeIndexedDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open("ExternalDispatches", 2);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(DISPATCH_STORE)) {
                    db.createObjectStore(DISPATCH_STORE, { keyPath: "id" });
                }
            };
            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e);
        });
    }

    function idExists(store, id) {
        return new Promise((resolve) => {
            const request = store.get(id);
            request.onsuccess = () => resolve(!!request.result);
            request.onerror = () => resolve(false);
        });
    }

    async function findStation(stationName) {
        const dataRef = ref(db, "Users");
        const stationQuery = query(dataRef, orderByChild("name"), equalTo(stationName));
        const snapshot = await get(stationQuery);

        if (snapshot.exists()) {
            const stationData = snapshot.val();
            const StationId = Object.keys(stationData)[0];
            return { StationId };
        }
        return null;
    }
</script> -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, set, get, query, orderByChild, equalTo, update, push, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZTB_mN_gIb6mqeM8nid4x83oKRehmFKo",
            authDomain: "farmer-project-sync.firebaseapp.com",
            databaseURL: "https://farmer-project-sync-default-rtdb.firebaseio.com",
            projectId: "farmer-project-sync",
            storageBucket: "farmer-project-sync.firebasestorage.app",
            messagingSenderId: "1366353203",
            appId: "1:1366353203:web:fa29fd29cc326a0d63ca46"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const DISPATCH_STORE = "Dispatch-Of-Dried-Nutmeg";
        const stations = ["Grenville", "Hermitage", "Marli", "Union", "Gouyave", "Victoria"];


        document.getElementById('syncButton').addEventListener('click', async () => {
            const btn = document.getElementById('syncButton');
            btn.disabled = true;
            btn.innerText = "Collecting...";

            console.log('Starting Sync Process...');
            await handleStationArray();

            btn.disabled = false;
            btn.innerText = "Dispatch Data Collection";
            alert("Collection Complete!");
        });

        async function handleStationArray() {
            console.log('CHECK1')
            for (const station of stations) {

                await getExtStationData(station)
            }
        }
        async function getExtStationData(stationName) {
            const existingStation = await findStation(stationName);
            if (existingStation) {
                loadDataFromFirebase(existingStation.StationId);

            } else {
                console.log(existingStation + "  not yet created")
            }
        }

        async function loadDataFromFirebase(stationId) {
            console.log(`Loading data for Station ID: ${stationId}`);
            // Pointing to the specific model store you defined
            const userRef = ref(db, `Users/${stationId}/models/${DISPATCH_STORE}`);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                const modelData = snapshot.val();
                await loadModelToIndexedDB(DISPATCH_STORE, modelData);
                console.log(`Data for ${DISPATCH_STORE} successfully loaded.`);
            } else {
                console.log(`No ${DISPATCH_STORE} data found for this station.`);
            }
        }
        async function loadModelToIndexedDB(modelName, modelData) {
            const db = await openDBWithStore(modelName);

            const transaction = db.transaction(modelName, "readwrite");
            const store = transaction.objectStore(modelName);

            const items = Array.isArray(modelData)
                ? modelData
                : Object.values(modelData);

            for (const item of items) {
                if (!item) continue;

                const newItem = { ...item };
                store.put(newItem);
            }

            await new Promise((resolve, reject) => {
                transaction.oncomplete = resolve;
                transaction.onerror = reject;
            });
        }


        function openDBWithStore(storeName) {
            return new Promise((resolve, reject) => {
                const DB_NAME = "ExternalDispatches";

                // Always bump version when schema might change
                const request = indexedDB.open(DB_NAME, 3);

                request.onupgradeneeded = (e) => {
                    const db = e.target.result;

                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName, {
                            keyPath: "id",
                            autoIncrement: true
                        });
                    }
                };

                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }


        // async function addExtDispatchData(stationName) {

        //     await loadDataFromFirebase(stationName);

        // }




        // async function loadModelToIndexedDB(modelName, modelData) {
        //     const db = await initializeIndexedDB();
        //     const transaction = db.transaction(modelName, "readwrite");
        //     const store = transaction.objectStore(modelName);


        //     if (Array.isArray(modelData)) {
        //         for (const item of modelData) {
        //             if (!item || item.id == null) {
        //                 console.error(`Item is missing 'id' field for model ${modelName}:`, item);
        //                 continue;
        //             }

        //             let newItem = { ...item };

        //             while (await idExists(store, newItem.id)) {
        //                 newItem.id += 1;
        //             }

        //             store.put(newItem); 
        //         }
        //     }



        //     else if (modelData && typeof modelData === 'object') {

        //         for (const item of Object.values(modelData)) {
        //             if (!item || item.id == null) {
        //                 console.error(`Item is missing 'id' field for model ${modelName}:`, item);
        //                 continue;
        //             }

        //             let updatedItem = { ...item };

        //             while (await idExists(store, updatedItem.id)) {
        //                 updatedItem.id += 1;
        //             }

        //             store.put(updatedItem); 
        //         }

        //     } else {
        //         console.error(`Unexpected modelData type for ${modelName}:`, modelData);
        //     }
        // }










        // async function getIndexedDBData() {
        //     const db = await initializeIndexedDB();
        //     return new Promise((resolve, reject) => {


        //         const transaction = db.transaction(dispatch, "readonly");
        //         const store = transaction.objectStore(dispatch);
        //         const request = store.getAll();

        //         request.onsuccess = function () {
        //             allData.push({ dispatch, data: request.result });
        //             if (allData.length === dispatch.length) {
        //                 resolve(allData);
        //             }
        //         };

        //         request.onerror = function () {
        //             reject("Error reading data from IndexedDB");
        //         };
        //     });
        // }



        function idExists(store, id) {
            return new Promise((resolve, reject) => {
                const request = store.get(id);

                request.onsuccess = () => {
                    resolve(!!request.result);
                };

                request.onerror = () => {
                    reject(request.error);
                };
            });
        }

        function initializeIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("ExternalDispatches", 2);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(DISPATCH_STORE)) {
                        db.createObjectStore(DISPATCH_STORE, { keyPath: "id" });
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }



        // function initializeIndexedDB() {
        //     return new Promise((resolve, reject) => {
        //         const dbVersion = 2;
        //         var request = indexedDB.open("ExternalDispatches", dbVersion);

        //         request.onupgradeneeded = function (event) {
        //             var db = event.target.result;
        //             console.log("Database upgrade needed. Creating object stores...");

        //             const modelNames = [
        //                 "Dispatch-Of-Dried-Nutmeg",
        //             ];

        //             modelNames.forEach((modelName) => {
        //                 if (!db.objectStoreNames.contains(modelName)) {
        //                     console.log(`Creating object store: ${modelName}`);
        //                     db.createObjectStore(modelName, { keyPath: "id" }); 
        //                 } else {
        //                     console.log(`Object store already exists: ${modelName}`);
        //                 }
        //             });
        //         };

        //         request.onsuccess = function (event) {
        //             console.log("IndexedDB initialized successfully.");
        //             resolve(event.target.result);
        //         };

        //         request.onerror = function (event) {
        //             console.error("Error opening IndexedDB:", event);
        //             reject("Error opening IndexedDB:", event);
        //         };
        //     });
        // }







        async function findStation(stationName) {
            const dataRef = ref(db, "Users");
            const stationQuery = query(dataRef, orderByChild("name"), equalTo(stationName));
            const snapshot = await get(stationQuery);

            if (snapshot.exists()) {
                const stationData = snapshot.val();
                const StationId = Object.keys(stationData)[0];
                console.log("Station found in Firebase with StationId:", StationId);
                return { StationId };
            } else {
                console.log("No Station found in Firebase.");
                return null;
            }
        }

    </script>


    <script>
        // Using a self-invoking block or unique prefixes to avoid conflicts with your original script
        const EXT_CONFIG = {
            storeName: 'Dispatch-Of-Dried-Nutmeg',
            dbName: 'ExternalDispatches',
            recordsPerPage: 10
        };

        let extCurrentPage = 1;
        let extAllRecords = [];

        document.addEventListener('DOMContentLoaded', function () {
            loadExternalDispatchRecords();

            const syncBtn = document.getElementById('syncButtonChange');
            if (syncBtn) {
                syncBtn.addEventListener('click', function () {
                    loadExternalDispatchRecords();
                });
            }
        });

        function loadExternalDispatchRecords() {
            const extContainer = document.getElementById('recordsContainer');
            extContainer.innerHTML = `
            <div class="text-center p-4">
                <div class="spinner-border text-danger" role="status"></div>
                <p class="mt-2">Accessing External Dispatch Store...</p>
            </div>
        `;

            const extRequest = indexedDB.open(EXT_CONFIG.dbName);

            extRequest.onerror = (event) => {
                console.error('External DB Error:', event.target.error);
                extContainer.innerHTML = `<div class="alert alert-danger">Error accessing database for external records.</div>`;
            };

            extRequest.onsuccess = (event) => {
                const db = event.target.result;

                if (!db.objectStoreNames.contains(EXT_CONFIG.storeName)) {
                    extContainer.innerHTML = `
                    <div class="no-records">
                        <h4 class="text-danger">External Store Not Found</h4>
                        <p>The store "${EXT_CONFIG.storeName}" does not exist in the GCNA database.</p>
                    </div>
                `;
                    return;
                }

                const transaction = db.transaction([EXT_CONFIG.storeName], 'readonly');
                const store = transaction.objectStore(EXT_CONFIG.storeName);
                const getAllReq = store.getAll();

                getAllReq.onsuccess = () => {
                    let records = getAllReq.result;

                    // Sort newest first
                    records.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    // Use a local version of applyFilters logic to avoid conflict
                    extAllRecords = extApplyFilters(records);
                    extDisplayRecords();
                };
            };
        }

        function extApplyFilters(records) {
            const stationFilt = document.getElementById('filterStation').value;
            const batchFilt = document.getElementById('searchBatchCode').value.trim().toLowerCase();

            return records.filter(record => {
                if (stationFilt && record.STATION_DRIED !== stationFilt && record.station !== stationFilt) return false;

                if (batchFilt) {
                    const searchString = JSON.stringify(record).toLowerCase();
                    if (!searchString.includes(batchFilt)) return false;
                }
                return true;
            });
        }

        //         function extDisplayRecords() {
        //             const extContainer = document.getElementById('recordsContainer');
        //             const extPagination = document.getElementById('pagination');

        //             if (extAllRecords.length === 0) {
        //                 extContainer.innerHTML = `<div class="alert alert-info">No records found in External Dispatch.</div>`;
        //                 extPagination.innerHTML = '';
        //                 return;
        //             }

        //             const start = (extCurrentPage - 1) * EXT_CONFIG.recordsPerPage;
        //             const end = start + EXT_CONFIG.recordsPerPage;
        //             const pageData = extAllRecords.slice(start, end);

        //             let html = '';
        //             let dried = '';
        //             let green = '';
        //             let mace = '';

        //             pageData.forEach(record => {
        //                 // Mapping fields commonly found in external/synced data
        //                 const displayDate = record.timestamp ? new Date(record.timestamp).toLocaleString() : 'N/A';
        //                 const station = record.STATION_DRIED || record.station || 'N/A';
        //                 const batchCodesM = record.BATCH_CODE_M1 || 'N/A';
        //                 const batchCodesD = record.BATCH_CODES_DRIED || 'N/A';
        //                 const batchCodesG = record.BATCH_CODES_GREEN || 'N/A';

        //   const existsInDB = (id) => {
        //             return new Promise((resolve, reject) => {
        //                 let openRequest = indexedDB.open("GCNA");
        //                 openRequest.onsuccess = function (event) {
        //                     let db = event.target.result;
        //                     let transaction = db.transaction("Dispatch_Of_Dried_Nutmeg_Rec", "readonly");
        //                     let store = transaction.objectStore("Dispatch_Of_Dried_Nutmeg_Rec");
        //                     let getRequest = store.get(id);

        //                     getRequest.onsuccess = function (e) {
        //                         resolve(!!e.target.result); // true if exists
        //                     };
        //                     getRequest.onerror = function () {
        //                         resolve(false);
        //                     };
        //                 };
        //                 openRequest.onerror = function () {
        //                     resolve(false);
        //                 };
        //             });
        //         };







        //                     // if (batchCodesM != '' || batchCodesM != 'N/A') {
        //         if (batchCodesM && !(await existsInDB(batchCodesM))) {

        //                         mace += `
        //              <div class="col-md-4 mb-4">
        //                       <form id="form_${record.id}">

        //                                 <h5>Mace Form Details</h5>
        //                                 <hr>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Station:</span> ${record.STATION_MACE || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Date of Purchase:</span> ${record.DATE_OF_PURCHASE_MACE || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Total Farmers:</span> ${record.TOTAL_NUM_OF_FARMERS_MACE || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Total Lbs Bought:</span> ${record.TOTAL_LBS_NUTMEG_BOUGHT_MACE || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Number of Bags:</span> ${record.NUM_OF_BAGS_MACE || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Batch Codes:</span><br>
        //                                     ${record.BATCH_CODE_M1 ? `<span class="batch-code">${record.BATCH_CODE_M1}</span>` : ''}
        //                                     ${record.BATCH_CODE_M2 ? `<span class="batch-code">${record.BATCH_CODE_M2}</span>` : ''}
        //                                     ${record.BATCH_CODE_M3 ? `<span class="batch-code">${record.BATCH_CODE_M3}</span>` : ''}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Delivery Advice:</span> ${record.Delivery_advice_num_MACE || 'N/A'}
        //                                 </div>
        //                                  <div class="detail-row">
        //                                                           <button type="button" onclick="dispatchRecieviedConfirmation(${record.id}, 'Yes')">Mark as Complete</button>
        //                                 </div>

        // </form>

        //                             </div>
        //             `;
        //                     }

        //                     if (batchCodesD != '' || batchCodesD != 'N/A') {

        //                         dried += `
        //                   <div class="col-md-4 mb-4">
        //       <form id="form_${record.id}">
        //                                 <h5>Dried Form Details</h5>
        //                                 <hr>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Station From:</span> ${record.STATION_DRIED || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Station To:</span> ${record.STATION_recieved_DRIED || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Batch Codes:</span><br>
        //                                     ${record.BATCH_CODES_DRIED ? record.BATCH_CODES_DRIED.split(',').map(code => `<span class="batch-code">${code.trim()}</span>`).join('') : 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Delivery Advice:</span> ${record.CORRESPONDING_DELIVERY_ADVICE || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Product:</span> ${record.Product || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Number of Bags:</span> ${record.Num_Bags_DRIED || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Weight:</span> ${record.Weight || 'N/A'}
        //                                 </div>
        //                                  <div class="detail-row">
        //                                                           <button type="button" onclick="dispatchRecieviedConfirmation(${record.id}, 'Yes')">Mark as Complete</button>
        //                                 </div>

        // </form>


        //                             </div>
        //             `;
        //                     }

        //                     if (batchCodesG != '' || batchCodesG != 'N/A') {

        //                         green += `
        // <div class="col-md-4 mb-4">
        //           <form id="form_${record.id}">

        //                                 <h5>Green Form Details</h5>
        //                                 <hr>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Date:</span> ${record.DATE_CREATED || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Station:</span> ${record.STATION_GREEN || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Date of Purchase:</span> ${record.DATE_OF_PURCHASE_GREEN || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Total Farmers:</span> ${record.TOTAL_NUM_OF_FARMERS_GREEN || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Total Lbs Bought:</span> ${record.TOTAL_LBS_NUTMEG_BOUGHT_GREEN || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Batch Codes:</span><br>
        //                                     ${record.BATCH_CODES_GREEN ? record.BATCH_CODES_GREEN.split(',').map(code => `<span class="batch-code">${code.trim()}</span>`).join('') : 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Number of Bags:</span> ${record.NUM_OF_BAGS_GREEN || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Delivery Advice:</span> ${record.DELIVERY_ADVICE_NUMBER || 'N/A'}
        //                                 </div>
        //                                 <div class="detail-row">
        //                                     <span class="detail-label">Warehouse Receipt:</span> ${record.WAREHOUSE_RECEIPT_NUMBER || 'N/A'}
        //                                 </div>
        //                                  <div class="detail-row">
        //                                                           <button type="button" onclick="dispatchRecieviedConfirmation(${record.id}, 'Yes')">Mark as Complete</button>
        //                                 </div>

        // </form>

        //                             </div>
        //             `;
        //                     }

        //             });


        //             extContainer.innerHTML = mace;



        //             extContainer.innerHTML = dried;


        //             extContainer.innerHTML = green;

        //             extRenderPagination();
        //         }
        async function extDisplayRecords() {
            const extContainer = document.getElementById('recordsContainer');
            const extPagination = document.getElementById('pagination');

            if (extAllRecords.length === 0) {
                extContainer.innerHTML = `<div class="alert alert-info">No records found in External Dispatch.</div>`;
                extPagination.innerHTML = '';
                return;
            }

            const start = (extCurrentPage - 1) * EXT_CONFIG.recordsPerPage;
            const end = start + EXT_CONFIG.recordsPerPage;
            const pageData = extAllRecords.slice(start, end);

            let mace = '', dried = '', green = '';

            // Function to check if a batch code exists in IndexedDB
            const existsInDB = (batchCode) => {
                return new Promise((resolve) => {
                    const openRequest = indexedDB.open("GCNA");
                    openRequest.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction("Dispatch_Of_Dried_Nutmeg_Rec", "readonly");
                        const store = transaction.objectStore("Dispatch_Of_Dried_Nutmeg_Rec");

                        const request = store.openCursor();
                        request.onsuccess = (e) => {
                            const cursor = e.target.result;
                            if (cursor) {
                                const record = cursor.value;
                                // Check if the batch code matches any of the potential storage fields
                                if (record.BATCH_CODE_M1 === batchCode ||
                                    record.BATCH_CODES_DRIED === batchCode ||
                                    record.BATCH_CODES_GREEN === batchCode) {
                                    resolve(true); // Batch found, return true to filter out
                                    return;
                                }
                                cursor.continue();
                            } else {
                                resolve(false); // End of table reached, batch not found
                            }
                        };
                    };
                    openRequest.onerror = () => resolve(false);
                });
            };


            for (const record of pageData) {
                const batchCodesM = record.BATCH_CODE_M1 || null;
                const batchCodesD = record.BATCH_CODES_DRIED || null;
                const batchCodesG = record.BATCH_CODES_GREEN || null;

                // --- MACE FORM ---
                if (batchCodesM && !(await existsInDB(batchCodesM))) {
                    mace += `
        <div class="col-md-4 mb-4" id="entryContainer_${record.id}">
            <form id="form_${record.id}">
                <input type="hidden" name="STATION_MACE" value="${record.STATION_MACE || ''}">
                <input type="hidden" name="DATE_OF_PURCHASE_MACE" value="${record.DATE_OF_PURCHASE_MACE || ''}">
                <input type="hidden" name="DATE_OF_MACE" value="${record.DATE_OF_MACE || ''}">
                <input type="hidden" name="TOTAL_NUM_OF_FARMERS_MACE" value="${record.TOTAL_NUM_OF_FARMERS_MACE || ''}">
                <input type="hidden" name="TOTAL_LBS_NUTMEG_BOUGHT_MACE" value="${record.TOTAL_LBS_NUTMEG_BOUGHT_MACE || ''}">
                <input type="hidden" name="NUM_OF_BAGS_MACE" value="${record.NUM_OF_BAGS_MACE || ''}">
                <input type="hidden" name="BATCH_CODE_M1" value="${record.BATCH_CODE_M1 || ''}">
                <input type="hidden" name="BATCH_CODE_M2" value="${record.BATCH_CODE_M2 || ''}">
                <input type="hidden" name="BATCH_CODE_M3" value="${record.BATCH_CODE_M3 || ''}">
                <input type="hidden" name="Delivery_advice_num_MACE" value="${record.Delivery_advice_num_MACE || ''}">
                <input type="hidden" name="form_type" value="mace">

                <h5>Mace Form Details</h5>
                <hr>
                <div class="detail-row"><span class="detail-label">Station:</span> ${record.STATION_MACE || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Date of Purchase:</span> ${record.DATE_OF_PURCHASE_MACE || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Date of Dispatch:</span> ${record.DATE_OF_MACE || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Total Farmers:</span> ${record.TOTAL_NUM_OF_FARMERS_MACE || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Total Lbs Bought:</span> ${record.TOTAL_LBS_NUTMEG_BOUGHT_MACE || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Number of Bags:</span> ${record.NUM_OF_BAGS_MACE || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Batch Codes:</span><br>
                    ${record.BATCH_CODE_M1 ? `<span class="batch-code">${record.BATCH_CODE_M1}</span>` : ''}
                    ${record.BATCH_CODE_M2 ? `<span class="batch-code">${record.BATCH_CODE_M2}</span>` : ''}
                    ${record.BATCH_CODE_M3 ? `<span class="batch-code">${record.BATCH_CODE_M3}</span>` : ''}
                </div>
                <div class="detail-row"><span class="detail-label">Delivery Advice:</span> ${record.Delivery_advice_num_MACE || 'N/A'}</div>
                <div class="detail-row"><button type="button" onclick="dispatchRecieviedConfirmation(${record.id})">Mark as Complete</button></div>
            </form>
        </div>`;
                }

                // --- DRIED FORM ---
                if (batchCodesD && !(await existsInDB(batchCodesD))) {
                    dried += `
        <div class="col-md-4 mb-4" id="entryContainer_${record.id}">
            <form id="form_${record.id}">
                <input type="hidden" name="STATION_DRIED" value="${record.STATION_DRIED || ''}">
                <input type="hidden" name="DATE_OF_DRIED" value="${record.DATE_OF_DRIED || ''}">
                <input type="hidden" name="STATION_recieved_DRIED" value="${record.STATION_recieved_DRIED || ''}">
                <input type="hidden" name="BATCH_CODES_DRIED" value="${record.BATCH_CODES_DRIED || ''}">
                <input type="hidden" name="CORRESPONDING_DELIVERY_ADVICE" value="${record.CORRESPONDING_DELIVERY_ADVICE || ''}">
                <input type="hidden" name="Product" value="${record.Product || ''}">
                <input type="hidden" name="form_type" value="dried">

                <input type="hidden" name="BATCHCODE_DRIED" value="${record.BATCH_CODES_DRIED || ''}">

                <input type="hidden" name="Num_Bags_DRIED" value="${record.Num_Bags_DRIED || ''}">
                <input type="hidden" name="Weight" value="${record.Weight || ''}">

                <h5>Dried Form Details</h5>
                <hr>
                <div class="detail-row"><span class="detail-label">Station From:</span> ${record.STATION_DRIED || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Station To:</span> ${record.STATION_recieved_DRIED || 'N/A'}</div>
                                <div class="detail-row"><span class="detail-label">Date of Dispatch:</span> ${record.DATE_OF_DRIED || 'N/A'}</div>

                <div class="detail-row"><span class="detail-label">Batch Codes:</span><br>
                    ${record.BATCH_CODES_DRIED ? record.BATCH_CODES_DRIED.split(',').map(c => `<span class="batch-code">${c.trim()}</span>`).join('') : 'N/A'}
                </div>
                <div class="detail-row"><span class="detail-label">Delivery Advice:</span> ${record.CORRESPONDING_DELIVERY_ADVICE || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Product:</span> ${record.Product || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Number of Bags:</span> ${record.Num_Bags_DRIED || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Weight:</span> ${record.Weight || 'N/A'}</div>
                <div class="detail-row"><button type="button" onclick="dispatchRecieviedConfirmation(${record.id})">Mark as Complete</button></div>
            </form>
        </div>`;
                }

                // --- GREEN FORM ---
                if (batchCodesG && !(await existsInDB(batchCodesG))) {
                    green += `
        <div class="col-md-4 mb-4" id="entryContainer_${record.id}">
            <form id="form_${record.id}">
                <input type="hidden" name="DATE_CREATED" value="${record.DATE_CREATED || ''}">
                <input type="hidden" name="STATION_GREEN" value="${record.STATION_GREEN || ''}">
                <input type="hidden" name="DATE_OF_DISPATCH_GREEN" value="${record.DATE_OF_DISPATCH_GREEN || ''}">
                <input type="hidden" name="DATE_OF_PURCHASE_GREEN" value="${record.DATE_OF_PURCHASE_GREEN || ''}">
                <input type="hidden" name="TOTAL_NUM_OF_FARMERS_GREEN" value="${record.TOTAL_NUM_OF_FARMERS_GREEN || ''}">
                <input type="hidden" name="TOTAL_LBS_NUTMEG_BOUGHT_GREEN" value="${record.TOTAL_LBS_NUTMEG_BOUGHT_GREEN || ''}">
                <input type="hidden" name="BATCH_CODES_GREEN" value="${record.BATCH_CODES_GREEN || ''}">
                <input type="hidden" name="NUM_OF_BAGS_GREEN" value="${record.NUM_OF_BAGS_GREEN || ''}">
                <input type="hidden" name="DELIVERY_ADVICE_NUMBER" value="${record.DELIVERY_ADVICE_NUMBER || ''}">
                <input type="hidden" name="WAREHOUSE_RECEIPT_NUMBER" value="${record.WAREHOUSE_RECEIPT_NUMBER || ''}">
                <input type="hidden" name="form_type" value="green">

                <h5>Green Form Details</h5>
                <hr>
                <div class="detail-row"><span class="detail-label">Date:</span> ${record.DATE_CREATED || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Station:</span> ${record.STATION_GREEN || 'N/A'}</div>
                                                <div class="detail-row"><span class="detail-label">Date of Dispatch:</span> ${record.DATE_OF_DISPATCH_GREEN || 'N/A'}</div>

                <div class="detail-row"><span class="detail-label">Date of Purchase:</span> ${record.DATE_OF_PURCHASE_GREEN || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Total Farmers:</span> ${record.TOTAL_NUM_OF_FARMERS_GREEN || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Total Lbs Bought:</span> ${record.TOTAL_LBS_NUTMEG_BOUGHT_GREEN || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Batch Codes:</span><br>
                    ${record.BATCH_CODES_GREEN ? record.BATCH_CODES_GREEN.split(',').map(c => `<span class="batch-code">${c.trim()}</span>`).join('') : 'N/A'}
                </div>
                <div class="detail-row"><span class="detail-label">Number of Bags:</span> ${record.NUM_OF_BAGS_GREEN || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Delivery Advice:</span> ${record.DELIVERY_ADVICE_NUMBER || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Warehouse Receipt:</span> ${record.WAREHOUSE_RECEIPT_NUMBER || 'N/A'}</div>
                <div class="detail-row"><button type="button" onclick="dispatchRecieviedConfirmation(${record.id})">Mark as Complete</button></div>
            </form>
        </div>`;
                }
            }
            // Combine all sections into the container
            extContainer.innerHTML = mace + dried + green;

            extRenderPagination();
        }

        function extRenderPagination() {
            const totalPages = Math.ceil(extAllRecords.length / EXT_CONFIG.recordsPerPage);
            const pagEl = document.getElementById('pagination');
            let html = '';

            for (let i = 1; i <= totalPages; i++) {
                html += `
                <li class="page-item ${i === extCurrentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="extChangePage(${i}); return false;">${i}</a>
                </li>
            `;
            }
            pagEl.innerHTML = html;
        }

        // Global helper for the onclick event in pagination
        window.extChangePage = function (pageNum) {
            extCurrentPage = pageNum;
            extDisplayRecords();
            window.scrollTo(0, 0);
        };






        function addOthers(id) {
            let openRequestup = indexedDB.open("GCNA");

            openRequestup.onsuccess = function (event) {
                let db1 = event.target.result;
                let transaction = db1.transaction("Dispatch_Of_Dried_Nutmeg_Rec", "readwrite");
                let InfoStore = transaction.objectStore("Dispatch_Of_Dried_Nutmeg_Rec");
                let getRequest = InfoStore.get(id);

                getRequest.onsuccess = function (event) {
                    let record = event.target.result;

                    // First save any edited values from the form
                    let form = document.getElementById(`form_${id}`);
                    let formData = new FormData(form);

                    // Update record with form values
                    for (let [key, value] of formData.entries()) {
                        record[key] = value;
                    }

                    // Then mark as complete
                    record.COMPLETE = 'Yes';

                    let updateRequest = InfoStore.put(record);
                    updateRequest.onsuccess = function () {
                        alert("Entry marked as complete!");
                        // Remove the entry from the display
                        let entryContainer = document.getElementById(`entryContainer_${id}`);
                        if (entryContainer) {
                            entryContainer.remove();
                        }
                        window.location.reload();
                    };
                };
            };
        }
        function dispatchRecieviedConfirmation(id) {
            const openRequest = indexedDB.open("GCNA");

            openRequest.onerror = () => {
                console.error("Failed to open IndexedDB");
            };

            openRequest.onsuccess = function (event) {
                const db = event.target.result;
                const transaction = db.transaction(
                    "Dispatch_Of_Dried_Nutmeg_Rec",
                    "readwrite"
                );
                const store = transaction.objectStore("Dispatch_Of_Dried_Nutmeg_Rec");

                const form = document.getElementById(`form_${id}`);
                if (!form) {
                    console.error(`Form form_${id} not found`);
                    return;
                }

                const formData = new FormData(form);
                const newRecord = {};

                //  Collect form fields
                for (const [key, value] of formData.entries()) {
                    newRecord[key] = value;
                }

                //  Add required metadata
                newRecord.COMPLETE = "Yes";
                newRecord.created_at = new Date().toISOString();

                //  Generate new id by getting the max existing id
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = function () {
                    const allRecords = getAllRequest.result;
                    let maxId = 0;

                    if (allRecords.length > 0) {
                        maxId = Math.max(...allRecords.map(record => record.id || 0));
                    }

                    newRecord.id = maxId + 1; // assign new id

                    //  Add the new record
                    const addRequest = store.add(newRecord);

                    addRequest.onerror = () => {
                        console.error("Failed to add record:", addRequest.error);
                    };

                    addRequest.onsuccess = () => {
                        addOthers(id)

                        // alert("New entry created successfully!");

                        // const entryContainer = document.getElementById(`entryContainer_${id}`);
                        // if (entryContainer) {
                        //     entryContainer.remove();
                        // }
                        // window.location.reload();
                    };
                };

                getAllRequest.onerror = () => {
                    console.error("Failed to get existing records:", getAllRequest.error);
                };
            };
        }


    </script>



    <script>
        // Set current date
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('current-date').textContent = formattedDate;

            // Load records
            loadRecords();

            // Set up event listeners for filters
            document.getElementById('applyFilters').addEventListener('click', function () {
                loadRecords();
            });

            document.getElementById('resetFilters').addEventListener('click', function () {
                document.getElementById('filterStation').value = '';
                document.getElementById('filterFormType').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                document.getElementById('searchBatchCode').value = '';
                loadRecords();
            });
        });

        // Global variables for pagination
        let currentPage = 1;
        let recordsPerPage = 10;
        let totalRecords = 0;
        let allRecords = [];

        // Function to load records from IndexedDB
        function loadRecords() {
            const recordsContainer = document.getElementById('recordsContainer');
            recordsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading records...</p>
                </div>
            `;

            const request = indexedDB.open('GCNA', 2);

            request.onerror = function (event) {
                console.error('Error opening database:', event.target.error);
                recordsContainer.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        Error opening database. Please try again later.
                    </div>
                `;
            };

            request.onsuccess = function (event) {
                const db = event.target.result;

                // Check if the object store exists
                if (!db.objectStoreNames.contains('Dispatch-Of-Dried-Nutmeg')) {
                    recordsContainer.innerHTML = `
                        <div class="no-records">
                            <h4>No Records Found</h4>
                            <p>The Dispatch-Of-Dried-Nutmeg database does not exist yet.</p>
                        </div>
                    `;
                    return;
                }

                const transaction = db.transaction(['Dispatch-Of-Dried-Nutmeg'], 'readonly');
                const objectStore = transaction.objectStore('Dispatch-Of-Dried-Nutmeg');
                const getAllRequest = objectStore.getAll();

                getAllRequest.onerror = function (event) {
                    console.error('Error retrieving records:', event.target.error);
                    recordsContainer.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            Error retrieving records. Please try again later.
                        </div>
                    `;
                };

                getAllRequest.onsuccess = function (event) {
                    let records = event.target.result;

                    if (records.length === 0) {
                        recordsContainer.innerHTML = `
                            <div class="no-records">
                                <h4>No Records Found</h4>
                                <p>There are no dispatched dried nutmeg records in the database.</p>
                            </div>
                        `;
                        return;
                    }

                    // Sort records by timestamp or ID (newest first)
                    records.sort((a, b) => {
                        if (a.timestamp && b.timestamp) {
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        }
                        return b.id - a.id;
                    });

                    // Apply filters
                    records = applyFilters(records);

                    // Store all filtered records for pagination
                    allRecords = records;
                    totalRecords = records.length;

                    // Display records with pagination
                    displayRecords();
                };
            };
        }

        // Function to apply filters to records
        function applyFilters(records) {
            const stationFilter = document.getElementById('filterStation').value;
            const formTypeFilter = document.getElementById('filterFormType').value;
            const startDateFilter = document.getElementById('startDate').value;
            const endDateFilter = document.getElementById('endDate').value;
            const batchCodeFilter = document.getElementById('searchBatchCode').value.trim().toLowerCase();

            return records.filter(record => {
                // Station filter
                if (stationFilter) {
                    const stationFields = [
                        record.STATION_MACE,
                        record.STATION_DRIED,
                        record.STATION_GREEN
                    ];

                    if (!stationFields.some(field => field === stationFilter)) {
                        return false;
                    }
                }

                // Form type filter
                if (formTypeFilter && record.forms_selected) {
                    if (!record.forms_selected[formTypeFilter]) {
                        return false;
                    }
                }

                // Date range filter
                if (startDateFilter || endDateFilter) {
                    const recordDate = record.timestamp ? new Date(record.timestamp) : null;

                    if (recordDate) {
                        if (startDateFilter) {
                            const startDate = new Date(startDateFilter);
                            if (recordDate < startDate) {
                                return false;
                            }
                        }

                        if (endDateFilter) {
                            const endDate = new Date(endDateFilter);
                            endDate.setHours(23, 59, 59, 999); // End of day
                            if (recordDate > endDate) {
                                return false;
                            }
                        }
                    }
                }

                // Batch code filter
                if (batchCodeFilter) {
                    const batchCodeFields = [
                        record.BATCH_CODE_M1,
                        record.BATCH_CODE_M2,
                        record.BATCH_CODE_M3,
                        record.BATCH_CODES_DRIED,
                        record.BATCH_CODES_GREEN
                    ];

                    const hasBatchCode = batchCodeFields.some(field => {
                        return field && field.toLowerCase().includes(batchCodeFilter);
                    });

                    if (!hasBatchCode) {
                        return false;
                    }
                }

                return true;
            });
        }

        // Function to display records with pagination
        function displayRecords() {
            const recordsContainer = document.getElementById('recordsContainer');
            const paginationElement = document.getElementById('pagination');

            // Calculate pagination
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            if (currentPage > totalPages) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, totalRecords);
            const recordsToDisplay = allRecords.slice(startIndex, endIndex);

            // Generate HTML for records
            let recordsHTML = '';

            if (recordsToDisplay.length === 0) {
                recordsHTML = `
                    <div class="no-records">
                        <h4>No Records Found</h4>
                        <p>No records match your filter criteria.</p>
                    </div>
                `;
            } else {
                recordsToDisplay.forEach(record => {
                    const formBadges = [];

                    if (record.forms_selected) {
                        if (record.forms_selected.mace) {
                            formBadges.push('<span class="badge badge-mace">Mace</span>');
                        }
                        if (record.forms_selected.dried) {
                            formBadges.push('<span class="badge badge-dried">Dried</span>');
                        }
                        if (record.forms_selected.green) {
                            formBadges.push('<span class="badge badge-green">Green</span>');
                        }
                    }

                    const recordDate = record.timestamp ? new Date(record.timestamp).toLocaleString() : 'Unknown Date';

                    recordsHTML += `
                        <div class="record-card">
                            <div class="card-header">
                                <div>
                                    <strong>Record ID: ${record.id}</strong>
                                    <div class="mt-1">${formBadges.join(' ')}</div>
                                </div>
                                <div class="text-end">
                                    <div>${recordDate}</div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                    `;

                    // Mace Form Details
                    if (record.forms_selected && record.forms_selected.mace) {
                        recordsHTML += `
                            <div class="col-md-4 mb-4">
                                <h5>Mace Form Details</h5>
                                <hr>
                                <div class="detail-row">
                                    <span class="detail-label">Station:</span> ${record.STATION_MACE || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Date of Purchase:</span> ${record.DATE_OF_PURCHASE_MACE || 'N/A'}
                                </div>

                                      <div class="detail-row">
                                    <span class="detail-label">Date of Dispatch:</span> ${record.DATE_OF_MACE || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Total Farmers:</span> ${record.TOTAL_NUM_OF_FARMERS_MACE || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Total Lbs Bought:</span> ${record.TOTAL_LBS_NUTMEG_BOUGHT_MACE || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Number of Bags:</span> ${record.NUM_OF_BAGS_MACE || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Batch Codes:</span><br>
                                    ${record.BATCH_CODE_M1 ? `<span class="batch-code">${record.BATCH_CODE_M1}</span>` : ''}
                                    ${record.BATCH_CODE_M2 ? `<span class="batch-code">${record.BATCH_CODE_M2}</span>` : ''}
                                    ${record.BATCH_CODE_M3 ? `<span class="batch-code">${record.BATCH_CODE_M3}</span>` : ''}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Delivery Advice:</span> ${record.Delivery_advice_num_MACE || 'N/A'}
                                </div>
                            </div>
                        `;
                    }

                    // Dried Form Details
                    if (record.forms_selected && record.forms_selected.dried) {
                        recordsHTML += `
                            <div class="col-md-4 mb-4">
                                <h5>Dried Form Details</h5>
                                <hr>
                                <div class="detail-row">
                                    <span class="detail-label">Station From:</span> ${record.STATION_DRIED || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Station To:</span> ${record.STATION_recieved_DRIED || 'N/A'}
                                </div>

                                           <div class="detail-row">
                                    <span class="detail-label">Date of Dispatch:</span> ${record.DATE_OF_DRIED || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Batch Codes:</span><br>
                                    ${record.BATCH_CODES_DRIED ? record.BATCH_CODES_DRIED.split(',').map(code => `<span class="batch-code">${code.trim()}</span>`).join('') : 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Delivery Advice:</span> ${record.CORRESPONDING_DELIVERY_ADVICE || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Product:</span> ${record.Product || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Number of Bags:</span> ${record.Num_Bags_DRIED || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Weight:</span> ${record.Weight || 'N/A'}
                                </div>
                            </div>
                        `;
                    }

                    // Green Form Details
                    if (record.forms_selected && record.forms_selected.green) {
                        recordsHTML += `<div class='header-container'>
                            <div class="col-md-4 mb-4 record-card">
                                <h5>Green Form Details</h5>
                                <hr>
                                <div class="detail-row">
                                    <span class="detail-label">Date:</span> ${record.DATE_CREATED || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Station:</span> ${record.STATION_GREEN || 'N/A'}
                                </div>

                                           <div class="detail-row">
                                    <span class="detail-label">Date of Dispatch:</span> ${record.DATE_OF_DISPATCH_GREEN || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Date of Purchase:</span> ${record.DATE_OF_PURCHASE_GREEN || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Total Farmers:</span> ${record.TOTAL_NUM_OF_FARMERS_GREEN || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Total Lbs Bought:</span> ${record.TOTAL_LBS_NUTMEG_BOUGHT_GREEN || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Batch Codes:</span><br>
                                    ${record.BATCH_CODES_GREEN ? record.BATCH_CODES_GREEN.split(',').map(code => `<span class="batch-code">${code.trim()}</span>`).join('') : 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Number of Bags:</span> ${record.NUM_OF_BAGS_GREEN || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Delivery Advice:</span> ${record.DELIVERY_ADVICE_NUMBER || 'N/A'}
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Warehouse Receipt:</span> ${record.WAREHOUSE_RECEIPT_NUMBER || 'N/A'}
                                </div>
                            </div>
                            </div>
                        `;
                    }

                    // Common Details
                    recordsHTML += `
                                    <div class="col-12 mt-3">
                                        <div class="collapse" id="moreDetails_${record.id}">
                                            <div class="card card-body bg-light">
                                                <h6>Additional Details</h6>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="detail-row">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="detail-row">
                                                            <span class="detail-label">Vehicle Number:</span> ${record.Vehicle_number || 'N/A'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-center mt-2">
                                            <a class="collapse-toggle" data-bs-toggle="collapse" href="#moreDetails_${record.id}" role="button" aria-expanded="false" aria-controls="moreDetails_${record.id}">
                                                Show More Details
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            recordsContainer.innerHTML = recordsHTML;

            // Generate pagination
            let paginationHTML = '';

            if (totalPages > 1) {
                paginationHTML += `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                `;

                const maxPagesToShow = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
                let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

                if (endPage - startPage + 1 < maxPagesToShow) {
                    startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                }

                paginationHTML += `
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                `;
            }

            paginationElement.innerHTML = paginationHTML;

            // Add event listeners to pagination links
            const pageLinks = document.querySelectorAll('.page-link');
            pageLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (!isNaN(page)) {
                        currentPage = page;
                        displayRecords();
                        window.scrollTo(0, 0);
                    }
                });
            });

            // Add event listeners to collapse toggles
            const collapseToggles = document.querySelectorAll('.collapse-toggle');
            collapseToggles.forEach(toggle => {
                toggle.addEventListener('click', function () {
                    const expanded = this.getAttribute('aria-expanded') === 'true';
                    this.textContent = expanded ? 'Show More Details' : 'Hide Details';
                });
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>




{% endblock %}