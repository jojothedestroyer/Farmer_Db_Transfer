{% extends 'gcna/base.html' %} {% block content%}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* General Styles */
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7; /* Adjusted background color */
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .card {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .card-body {
      padding: 20px;
    }

    h4 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th,
    td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      font-weight: bold;
      color: #555;
    }

    td {
      color: #777;
    }

    button {
      cursor: pointer;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: #fff;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    /* Form Styles */
    record {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 16px;
      color: #333;
      outline: none;
    }

    #saveButton,
    #closeButton {
      margin-top: 10px;
      background-color: #28a745;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #closeButton {
      background-color: #dc3545;
      margin-left: 10px;
    }

    /* Responsive Styles */
    @media screen and (max-width: 768px) {
      .container {
        max-width: 90%;
      }
    }
  </style>







 


<style>
  .table {
      width: 100%;
      border-collapse: collapse;
      background-color: #ffffff;
      font-family: Raleway;
      border-radius: 10px;
      /* box-shadow: 0 2px 25px rgba(0, 0, 0, 0.2); */
  }

  .table th, .table td {
      padding: 10px;
      text-align: center;
      border: 1px solid #e4e4e4;
      min-width: 150px; /* Ensure cells have a minimum width */
  }

  .table th {
      background-color: #f8f9fa;
      font-weight: bold;
  }

  .form-control {
      width: 100%; /* Full width of the cell */
      min-width: 150px; /* Minimum width for dropdowns and inputs */
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px; /* Ensure text is readable */
  }

  .add-row, .submit_contents {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      font-size: 14px; /* Ensure button text is readable */
  }

  .add-row:hover, .submit_contents:hover {
      background-color: #0056b3;
  }



  
  .addrow, .submit_contents {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      font-size: 14px; /* Ensure button text is readable */
  }

  .addrow:hover, .submit_contents:hover {
      background-color: #0056b3;
  }
#entryCheck{
  display: none;
}
  .hidden-label1 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      display: block;
  }

  /* Ensure the table is responsive */
  @media (max-width: 768px) {
      .table th, .table td {
          min-width: 120px; /* Adjust for smaller screens */
      }

      .form-control {
          min-width: 120px; /* Adjust for smaller screens */
          font-size: 12px; /* Smaller font size for smaller screens */
      }

      .add-row, .submit_contents {
          font-size: 12px; /* Smaller font size for smaller screens */
      }
  }
</style>













</head>
<body>
  <div class="container"></div>

  <div id="landInfoData"></div>


  
<script>

function toggleRecord(id) {
  const details = document.getElementById(`recordDetails-${id}`);

  if (details.style.display === "none") {
    details.style.display = "block";
  } else {
    details.style.display = "none";
  }
}


    let openRequest = indexedDB.open("GCNA");
    let fieldBlacklist = [];
    const fieldBlacklistConfig = {
      DATE_OF_SAMPLING: true, // Set to true to blacklist if null or empty
      DECISION: true,
      Quantity_of_Bags: true,
    };
    openRequest.onsuccess = function (event) {
      let db = event.target.result;
      let transaction = db.transaction("In-House-Drying", "readonly");
      let landInfoStore = transaction.objectStore("In-House-Drying");
      let getAllRequest = landInfoStore.getAll();

      getAllRequest.onsuccess = function (event) {
        let landInfoRecords = event.target.result;
        let landInfoDataDiv = document.getElementById("landInfoData");

        // Sort records by DATE_OF_PURCHASE in descending order (newest first)
        landInfoRecords.sort((a, b) => {
          const dateA = new Date(a.DATE_OF_PURCHASE);
          const dateB = new Date(b.DATE_OF_PURCHASE);
          return dateB - dateA;
        });

        landInfoRecords.forEach((record) => {
        //   let entryContainer = document.createElement("div");
        //   entryContainer.id = `entryContainer_${record.id}`;



let entryContainer = document.createElement("div");
entryContainer.id = `entryContainer_${record.id}`;
entryContainer.className = "record-container";
let labelText = record.Control_number && record.Control_number !== ""
  ? record.Control_number
  : (record.BATCH_CODE || `Record ${record.id}`);

entryContainer.innerHTML = `
  <button class="btn btn-primary" 
          onclick="toggleRecord(${record.id})" 
          style="width:100%; text-align:left; margin-bottom:8px;">
    ${labelText} 
  </button>

  <div id="recordDetails-${record.id}" style="display:none;"> 
      <form>
      <div class="card">
        <div class="card-body">
        <p class="card-text">

        <table id="vertical-1" class="table table-hover table-light">
          <tr>
            <th>Station</th>
            <td>${record.STATION}</td>
          </tr>  
          <tr>
            <th>Date of Purchase</th>
            <td>${record.DATE_OF_PURCHASE}</td>
          </tr>
          <tr>
            <th>Place of Purchase</th>
            <td>${record.PLACE_OF_PURCHASE}</td>
          </tr>
          <tr>
            <th>Number of Farmers</th>
            <td>${record.TOTAL_NUM_OF_FARMERS}</td>
          </tr>
          <tr>
            <th>Number of Bags</th>
            <td>${record.NUM_OF_BAGS}</td>
          </tr>
          <tr style="display: none;">
            <td id="entryCheck">${record.entryCheck}</td>
          </tr>
          <tr>
            <th>Total Nutmegs bought (lbs)</th>
            <td>${record.TOTAL_LBS_NUTMEG_BOUGHT}</td>
          </tr>
          <tr>
            <th>Complete</th>
            <td>
              <button onclick="saveEditedCompletion(${record.id}, 'Yes')">Entry Complete?</button>
            </td>
          </tr>
          <!-- Dates table wrapped inside a row -->
          <tr>
            <td colspan="2">
              <label>Dates</label>
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Start Drying Date</th>
                    <th scope="col">Approximate End Drying Date</th>
                    <th scope="col">End Drying Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><input type="date" class="form-control" value="${record.START_DRYING_DATE}" onchange="saveEditedDate2(${record.id}, this.value)"></td>
                    <td><input type="date" class="form-control" id="date-${record.id}" value="${record.APPROX_END_DRYING_DATE}" readonly></td>
                    <td><input type="date" class="form-control" value="${record.END_DRYING_DATE}" onchange="saveEditedDate(${record.id}, this.value)"></td>
                  </tr>
                </tbody>
              </table>
            </td>
          </tr>
        </table>

        <center>
          <button id="shelvebtn" data-entry="${record.entryCheck}">Add Shelves</button>
        </center>

        <br/><br/>

        <div id="newShelves-${record.entryCheck}"></div>
        <div id="landInfoData1"></div>

<br>  
<br>  
<br>  
<br>  
<br>  
<br>  

          <tr>
         <center>
            <p>MOISTURE TESTING (Weeks 3, 6, 8)</p>
        <center>
                   <center>
          <button id="moisturebtn" data-entry="${record.entryCheck}">Add Moisture Row</button>
        </center>
        <tr style="display: none;">
            <div id="newMoistureShelves-${record.entryCheck}"></div>
          </tr>

<div id="landInfoData2"></div>
</center>
        </tr>

<br>  
<br>  
<br>  
<br>  
<br>  
<br>  

<table class="table" >
    <center>
<label class="hidden-label5">MONITORING AND INSPECTION</label>   
 </center> 
  <thead>
    <tr>
      <th scope="col">Station</th>
      <th scope="col">Location</th>
      <th scope="col">Defect</th>
      <th scope="col">Predominant Defect</th>
     </tr>
  </thead>
  <tbody>
    <tr>
      <td>${record.STATION2}</td>
      <td>${record.LOCATION3}</td>
      <td>${record.DEFECT}</td>
      <td>${record.PREDOMINANT_DEFECT}</td>
    </tr>
  </tbody>
</table>

<table class="table">
  <tbody>
    <tr>
       <td>ALERT</td>
      <td>${record.ALERT}</td>
    </tr>
  </tbody>
</table>

<table id="vertical-1" class="table table-hover table-light">
        <tr>
            <th>Sampling from Gouyvae</th>
            <td>${record.Sampling_from_gouyvae}</td>
        </tr>
        <tr>
            <th>Control Number</th>
            <td>${record.Control_number}</td>
        </tr>
</table>
            </div>
               </div>
               </form>
                              <br> <br> <br>
           `;
           if (
            record.COMPLETE == null ||
            record.COMPLETE == "" ||
            record.COMPLETE == "null" ||
            record.COMPLETE == "N" ||
            record.COMPLETE == "n" ||
            record.COMPLETE == "No" ||
            record.COMPLETE == "no"
          ) {
            landInfoDataDiv.appendChild(entryContainer);
          }
        });
      };
    };
    
    function saveEditedDate(id, newDate) {
      let openRequestup = indexedDB.open("GCNA");

      openRequestup.onsuccess = function (event) {
        let db1 = event.target.result;
        let transaction = db1.transaction("In-House-Drying", "readwrite");
        let landInfoStore = transaction.objectStore("In-House-Drying");
        let getRequest = landInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;
          record.END_DRYING_DATE = newDate;

          let updateRequest = landInfoStore.put(record);
          updateRequest.onsuccess = function () {
            console.log("End Drying Date updated successfully!");
          };
        };
      };
    }

    function saveEditedDate2(id, newDate) {
      let openRequestup = indexedDB.open("GCNA");

      openRequestup.onsuccess = function (event) {
        let db1 = event.target.result;
        let transaction = db1.transaction("In-House-Drying", "readwrite");
        let landInfoStore = transaction.objectStore("In-House-Drying");
        let getRequest = landInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;
          if (record) {
            let startDate = new Date(newDate);
            let newerDate = new Date(startDate); 
            newerDate.setDate(newerDate.getDate() + 42); 
            record.START_DRYING_DATE = startDate.toISOString().split("T")[0];
            record.APPROX_END_DRYING_DATE = newerDate.toISOString().split("T")[0];

            let updateRequest = landInfoStore.put(record);
            updateRequest.onsuccess = function () {
              console.log("Start Drying Date and Approx End Drying Date updated successfully!");

              let dateInput = document.querySelector(`#date-${id}`);
              if (dateInput) {
                dateInput.value = record.APPROX_END_DRYING_DATE;
              }
            };
          } else {
            console.log("Record not found for ID:", id);
          }
        };
      };
    }

    function saveEditedCompletion(id, completion) {
      let openRequestup = indexedDB.open("GCNA");

      openRequestup.onsuccess = function (event) {
        let db1 = event.target.result;
        let transaction = db1.transaction("In-House-Drying", "readwrite");
        let landInfoStore = transaction.objectStore("In-House-Drying");
        let getRequest = landInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;
          record.COMPLETE = completion;

          let updateRequest = landInfoStore.put(record);
          updateRequest.onsuccess = function () {
            console.log("End Drying Date updated successfully!");
          };
        };
      };
    };
  </script>





<script>
    let openRequest2 = indexedDB.open("GCNA");

    openRequest2.onsuccess = function (event) {
        let db = event.target.result;
        let transaction = db.transaction("Shelves", "readonly");
        let landInfoStore = transaction.objectStore("Shelves");
        let getAllRequest = landInfoStore.getAll();

        getAllRequest.onsuccess = function (event) {
            let landInfoRecords = event.target.result;
            let tables = document.querySelectorAll(".table"); 

            tables.forEach(table => {
                let existingDiv = table.querySelector(".landInfoData1");
                if (existingDiv) {
                    existingDiv.remove();
                }
            });

            tables.forEach((table) => {
                let entryCheckTd = table.querySelector("td#entryCheck");
                if (!entryCheckTd) return;

                let entryValue = entryCheckTd.textContent.trim();
                let landInfoDataDiv = document.createElement("div");
                landInfoDataDiv.className = "landInfoData1";
                table.appendChild(landInfoDataDiv);

                let matchingRecords = landInfoRecords.filter(record => record.entry === entryValue);

                matchingRecords.forEach((record) => {
                    let entryContainer = document.createElement("div");
                    entryContainer.className = "entry-container";
                    entryContainer.dataset.formId = table.id;
                    entryContainer.dataset.recordId = record.id;

                    const recordId = Number(record.id);

                    entryContainer.innerHTML = `
                        <table class="table" id="record-table-${recordId}">
                            <center>
                                <h5 class="card-title" contenteditable="true" data-record-id="${recordId}" data-field="floor">${record.floor}</h5>
                                <br/>
                                <button class="btn btn-danger delete-btn" data-record-id="${recordId}"   onclick="deleteEntry(${recordId}, this)">Delete</button>
                            </center>
                            <thead>
                                <tr>
                                    <th scope="col">Shelf</th>
                                    <th scope="col">Tray</th>
                                    <th scope="col">Section</th>
                                    <th scope="col">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td contenteditable="true" data-record-id="${recordId}" data-field="Shelf">${record.Shelf}</td>
                                    <td contenteditable="true" data-record-id="${recordId}" data-field="Tray">${record.Tray}</td>
                                    <td contenteditable="true" data-record-id="${recordId}" data-field="Section">${record.Section}</td>
                                    <td contenteditable="true" data-record-id="${recordId}" data-field="amount">${record.amount}</td>
                                </tr>
                                <tr style="display: none;">
                                    <td style="opacity: 0;">${record.floor}</td>
                                    <td style="opacity: 0;">${record.entry}</td>
                                    <td style="opacity: 0;">${record.station}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    landInfoDataDiv.appendChild(entryContainer);

                });

                landInfoDataDiv.addEventListener('blur', function (e) {
                    if (e.target && e.target.hasAttribute('contenteditable') && e.target.dataset.recordId && e.target.dataset.field) {
                        const recordIdToUpdate = parseInt(e.target.dataset.recordId, 10);
                        const fieldToUpdate = e.target.dataset.field;
                        let newValue = e.target.textContent.trim();

                        if (fieldToUpdate === "amount") {
                            const numericValue = parseFloat(newValue);
                            if (isNaN(numericValue)) {
                                console.error("Invalid amount: Not a number. Reverting or add validation.");
                                const originalRecord = landInfoRecords.find(r => r.id === recordIdToUpdate);
                                if (originalRecord) {
                                    e.target.textContent = originalRecord[fieldToUpdate];
                                }
                                return;
                            }
                            newValue = numericValue;
                        } else if (fieldToUpdate === "floor" && e.target.tagName === 'H5') {
                        }

                        console.log(`Attempting to save: ID=${recordIdToUpdate}, Field=${fieldToUpdate}, Value=${newValue}`);
                        saveUpdatedRecordField(recordIdToUpdate, fieldToUpdate, newValue);
                    }
                }, true);

                // landInfoDataDiv.addEventListener('click', function(event) {
                //     if (event.target.classList.contains('delete-btn')) {
                //         const recordIdToDelete = parseInt(event.target.dataset.recordId, 10);
                //         const recordTable = document.getElementById(`record-table-${recordIdToDelete}`); 
                //         if (recordTable) {
                //             deleteEntry(recordIdToDelete, recordTable);
                //         } else {
                //             deleteEntry(recordIdToDelete);
                //         }
                //     }
                // });
            });
        };
        getAllRequest.onerror = function (event) {
            console.error("Error fetching all records: ", event.target.error);
        };
    };
    openRequest2.onerror = function (event) {
        console.error("Failed to open GCNA database for reading: ", event.target.error);
    };
function deleteEntry(recordId, btn) {
    if (!confirm("Are you sure you want to delete this record?")) return;

    let openRequest = indexedDB.open("GCNA");

    openRequest.onerror = function () {
        console.error("Failed to open IndexedDB");
    };

    openRequest.onsuccess = function (event) {
        let db = event.target.result;

        // ðŸ”‘ MUST be readwrite to delete
        let transaction = db.transaction("Shelves", "readwrite");
        let store = transaction.objectStore("Shelves");

        let deleteRequest = store.delete(Number(recordId));

        deleteRequest.onsuccess = function () {
            console.log("Record deleted from IndexedDB:", recordId);

            // âœ… Remove from UI
            const entryContainer = btn.closest(".entry-container");
            if (entryContainer) {
                entryContainer.remove();
            }
        };

        deleteRequest.onerror = function () {
            console.error("Failed to delete record:", recordId);
        };

        transaction.oncomplete = function () {
            db.close();
        };
    };
}

    function saveUpdatedRecordField(recordId, fieldName, newValue) {
        let openRequest = indexedDB.open("GCNA");

        openRequest.onsuccess = function (event) {
            let db = event.target.result;
            let transaction = db.transaction("Shelves", "readwrite");
            let store = transaction.objectStore("Shelves");
            let getRequest = store.get(recordId);

            getRequest.onsuccess = function (e) {
                let record = e.target.result;
                if (record) {
                    if (record.hasOwnProperty(fieldName)) {
                        record[fieldName] = newValue;
                        let putRequest = store.put(record);

                        putRequest.onsuccess = function () {
                            console.log(`Record ${recordId} updated successfully. Field: ${fieldName}, New Value: ${newValue}`);
                        };
                        putRequest.onerror = function (putEvent) {
                            console.error(`Error updating record ${recordId}. Field: ${fieldName}`, putEvent.target.error);
                        };
                    } else {
                        console.warn(`Field "${fieldName}" does not exist on record ${recordId}. Update skipped.`);
                    }
                } else {
                    console.error(`Record ${recordId} not found for update.`);
                }
            };
            getRequest.onerror = function (getEvent) {
                console.error(`Error fetching record ${recordId} for update: `, getEvent.target.error);
            };

            transaction.oncomplete = function () {
                console.log(`Transaction completed for updating record ${recordId}.`);
            };
            transaction.onerror = function (transEvent) {
                console.error("Transaction error during update: ", transEvent.target.error);
            };
        };
        openRequest.onerror = function (event) {
            console.error("Failed to open GCNA database for saving changes: ", event.target.error);
        };
    }





    // function deleteEntry(id, recordTableElement) {
    //   event.preventDefault()
    //     const recordIdToDelete = Number(id);

    //     let openRequest = indexedDB.open("GCNA");

    //     openRequest.onsuccess = function (event) {
    //         let db = event.target.result;

    //         let getTransaction = db.transaction("Shelves", "readonly");
    //         let landInfoStoreGet = getTransaction.objectStore("Shelves");
    //         let getRequest = landInfoStoreGet.get(recordIdToDelete);

    //         getRequest.onsuccess = function (e_get) {
    //             let recordToCopy = e_get.target.result;

    //             if (recordToCopy) {
    //                 let openDeletedRequest = indexedDB.open("DELETED");

    //                 openDeletedRequest.onupgradeneeded = function (e_upgrade) {
    //                     let deletedDBUpgrade = e_upgrade.target.result;
    //                     if (!deletedDBUpgrade.objectStoreNames.contains("Shelves")) {
    //                         deletedDBUpgrade.createObjectStore("Shelves", {
    //                             keyPath: "id"
    //                         });
    //                         console.log("DELETED/Shelves object store created.");
    //                     }
    //                 };

    //                 openDeletedRequest.onsuccess = function (e_deleted_db) {
    //                     let deletedDB = e_deleted_db.target.result;
    //                     if (!deletedDB.objectStoreNames.contains("Shelves")) {
    //                         console.error("DELETED database does not have 'Shelves' object store. Record not copied.");
    //                         proceedWithDeletion(db, recordIdToDelete, recordTableElement);
    //                         return;
    //                     }
    //                     let deletedTransaction = deletedDB.transaction("Shelves", "readwrite");
    //                     let deletedStore = deletedTransaction.objectStore("Shelves");
    //                     let addRequest = deletedStore.add(recordToCopy);

    //                     addRequest.onsuccess = function () {
    //                         console.log(`Record with ID ${recordIdToDelete} copied to DELETED database.`);
    //                         proceedWithDeletion(db, recordIdToDelete, recordTableElement);
    //                     };
    //                     addRequest.onerror = function (add_err) {
    //                         console.log(`Failed to copy record with ID ${recordIdToDelete} to DELETED database. Error: ${add_err.target.error}`);
    //                         proceedWithDeletion(db, recordIdToDelete, recordTableElement);
    //                     };
    //                 };
    //                 openDeletedRequest.onerror = function (deleted_err) {
    //                     console.log("Failed to open/setup DELETED database. Error: ", deleted_err.target.error);
    //                     proceedWithDeletion(db, recordIdToDelete, recordTableElement);
    //                 };
    //             } else {
    //                 console.log(`Record with ID ${recordIdToDelete} not found in GCNA. Cannot copy to DELETED.`);
    //                 // window.location.reload();
    //                 if(recordTableElement){
    //                      recordTableElement.remove();
    //                 }
    //             }
    //         };
    //         getRequest.onerror = function (get_err) {
    //             console.error(`Error fetching record ${recordIdToDelete} for copying: ${get_err.target.error}`);
    //             proceedWithDeletion(db, recordIdToDelete, recordTableElement);
    //         };
    //     };
    //     openRequest.onerror = function (open_err) {
    //         console.log("Failed to open GCNA database for delete operation. Error: ", open_err.target.error);
    //     };
    // }

    // function proceedWithDeletion(db, recordIdToDelete, recordTableElement) {
    //     let transaction = db.transaction("Shelves", "readwrite");
    //     let landInfoStore = transaction.objectStore("Shelves");
    //     let deleteRequest = landInfoStore.delete(recordIdToDelete);

    //     deleteRequest.onsuccess = function () {
    //         console.log(`Record with ID ${recordIdToDelete} deleted from GCNA database.`);
    //         // Remove the table row from the DOM
    //         if (recordTableElement) {
    //             recordTableElement.remove();
    //         }
    //     };
    //     deleteRequest.onerror = function (del_err) {
    //         console.log(`Failed to delete record with ID ${recordIdToDelete} from GCNA database. Error: ${del_err.target.error}`);
    //     };
    //      transaction.onerror = function(trans_err) {
    //         console.error("Transaction error during delete: ", trans_err.target.error);
    //     };
    // }


//  function deleteEntry(id, recordTableElement) {
//         const recordIdToDelete = Number(id);

//         console.log("[v0] Starting deletion for record ID:", recordIdToDelete);

//         let openRequest = indexedDB.open("GCNA");

//         openRequest.onsuccess = function (event) {
//             let db = event.target.result;

//             let getTransaction = db.transaction("Shelves", "readonly");
//             let landInfoStoreGet = getTransaction.objectStore("Shelves");
//             let getRequest = landInfoStoreGet.get(recordIdToDelete);

//             getRequest.onsuccess = function (e_get) {
//                 let recordToCopy = e_get.target.result;

//                 if (recordToCopy) {
//                     console.log("[v0] Record found, copying to DELETED database");
                    
//                     let openDeletedRequest = indexedDB.open("DELETED");

//                     openDeletedRequest.onupgradeneeded = function (e_upgrade) {
//                         let deletedDBUpgrade = e_upgrade.target.result;
//                         if (!deletedDBUpgrade.objectStoreNames.contains("Shelves")) {
//                             deletedDBUpgrade.createObjectStore("Shelves", {
//                                 keyPath: "id"
//                             });
//                             console.log("DELETED/Shelves object store created.");
//                         }
//                     };

//                     openDeletedRequest.onsuccess = function (e_deleted_db) {
//                         let deletedDB = e_deleted_db.target.result;
//                         if (!deletedDB.objectStoreNames.contains("Shelves")) {
//                             console.error("DELETED database does not have 'Shelves' object store. Record not copied.");
//                             proceedWithDeletion(db, recordIdToDelete, recordTableElement);
//                             return;
//                         }
//                         let deletedTransaction = deletedDB.transaction("Shelves", "readwrite");
//                         let deletedStore = deletedTransaction.objectStore("Shelves");
//                         let addRequest = deletedStore.add(recordToCopy);

//                         addRequest.onsuccess = function () {
//                             console.log(`Record with ID ${recordIdToDelete} copied to DELETED database.`);
//                             proceedWithDeletion(db, recordIdToDelete, recordTableElement);
//                         };
//                         addRequest.onerror = function (add_err) {
//                             console.log(`Failed to copy record with ID ${recordIdToDelete} to DELETED database. Error: ${add_err.target.error}`);
//                             proceedWithDeletion(db, recordIdToDelete, recordTableElement);
//                         };
//                     };
//                     openDeletedRequest.onerror = function (deleted_err) {
//                         console.log("Failed to open/setup DELETED database. Error: ", deleted_err.target.error);
//                         proceedWithDeletion(db, recordIdToDelete, recordTableElement);
//                     };
//                 } else {
//                     console.log(`[v0] Record with ID ${recordIdToDelete} not found in GCNA. Proceeding with deletion anyway.`);
//                     proceedWithDeletion(db, recordIdToDelete, recordTableElement);
//                 }
//             };
//             getRequest.onerror = function (get_err) {
//                 console.error(`Error fetching record ${recordIdToDelete} for copying: ${get_err.target.error}`);
//                 proceedWithDeletion(db, recordIdToDelete, recordTableElement);
//             };
//         };
//         openRequest.onerror = function (open_err) {
//             console.log("Failed to open GCNA database for delete operation. Error: ", open_err.target.error);
//         };
//     }

//     function proceedWithDeletion(db, recordIdToDelete, recordTableElement) {
//         console.log("[v0] Proceeding with deletion from IndexedDB for record ID:", recordIdToDelete);
        
//         let transaction = db.transaction("Shelves", "readwrite");
//         let landInfoStore = transaction.objectStore("Shelves");
//         let deleteRequest = landInfoStore.delete(recordIdToDelete);

//         deleteRequest.onsuccess = function () {
//             console.log(`[v0] Record with ID ${recordIdToDelete} successfully deleted from GCNA database.`);
//             // Remove the table row from the DOM
//             if (recordTableElement) {
//                 recordTableElement.remove();
//             }
//         };
//         deleteRequest.onerror = function (del_err) {
//             console.log(`[v0] Failed to delete record with ID ${recordIdToDelete} from GCNA database. Error: ${del_err.target.error}`);
//         };
//         transaction.onerror = function(trans_err) {
//             console.error("[v0] Transaction error during delete: ", trans_err.target.error);
//         };
//     }

</script>









<script>
document.addEventListener('click', function(event) {
    if (event.target.id === 'moisturebtn') {
        event.preventDefault();
        const entryCheck = event.target.getAttribute('data-entry');
        const container = document.getElementById(`newMoistureShelves-${entryCheck}`);
        
        if (container) {
            addMForm('newMoistureShelves', 'mainForm', container, entryCheck);
        } else {
            console.error(`Container not found for entryCheck: ${entryCheck}`);
        }
    }
});
formCount=0;
function addMForm(tableId, mainFormId, container, entryCheck) {
    formCount++;
    const form = document.createElement('form');
    form.id = `form_${formCount}_${entryCheck}`;
    form.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Floor:</th>
                    <th scope="col">Shelf:</th>
                    <th scope="col">Tray:</th>
                    <th scope="col" colspan=2>Section:</th>
                    <th scope="col">Moisture</th>
                    <th>Week</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                  <td>
                        <select id="floor_${entryCheck}_${formCount}_M" class="form-control" name="floor" required>
                            <option value="">--Select Floor--</option>
                            <option value="Ground Floor">Ground Floor</option>
                            <option value="1st Floor">1st Floor</option>
                            <option value="2nd Floor">2nd Floor</option>
                            <option value="Floor Loft">Floor Loft</option>
                        </select>
                    </td>
                    <td>
                        <select id="Shelf_${entryCheck}_${formCount}_M" class="form-control" name="M_Shelf" required>
                            <option value="">--Select Shelf--</option>
                            ${generateOptions(SHELF00)}
                        </select>
                    </td>
                    <td>
                        <select id="Tray_${entryCheck}_${formCount}_M" class="form-control" name="M_Tray" required>
                            <option value="">--Select Tray--</option>
                            ${generateOptions(TRAY00)}
                        </select>
                    </td>
                    <td>
                        <select id="section1_${entryCheck}_${formCount}_M" class="form-control" name="section1" required onchange="updateSectionValue_M('${entryCheck}','${formCount}')">
                            <option value="">--Select Section--</option>
                            ${generateOptions(SECTION00)}
                        </select>
                    </td>
                    <td>
                        <select id="section2_${entryCheck}_${formCount}_M" class="form-control" name="section2" required onchange="updateSectionValue_M('${entryCheck}','${formCount}')">
                            <option value="">--Select Section--</option>
                            ${generateOptions(SECTION00)}
                        </select>
                        <input type="hidden" id="Section_${entryCheck}_${formCount}_M" name="M_Section">
                    </td>
                    <td>
                        <input type="text" id="amount_${entryCheck}_${formCount}_M" class="form-control" name="Moisture" required>
                    </td>
                    <td>
                        <input type="text" id="week_${entryCheck}_${formCount}_M" class="form-control" name="Week" required>
                    </td>
                    <td>
                        <input type="date" value="${new Date().toISOString().split('T')[0]}" id="date_${entryCheck}_${formCount}_M" class="form-control" name="Date" required>
                    </td>
                    <td>
                        <button type="button" class="submit_contents" onclick="submitMForm('${tableId}', '${mainFormId}', ${formCount}, '${entryCheck}')">âœ”</button>
                    </td>
                    <td>
                        <button type="button" class="addrow" onclick="removeForm('form_${formCount}_${entryCheck}')">Close</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div>
            <input type="hidden" id="entry_${entryCheck}" name="entry" value="${entryCheck}">
            <input type="hidden" id="station_${entryCheck}" name="station">
        </div>
    `;
    container.appendChild(form);
}

async function submitMForm(tableId, mainFormId, formNumber, entryCheck) {
    try {
        const formId = `form_${formNumber}_${entryCheck}`;
        const form = document.getElementById(formId);
        
        if (!form) {
            throw new Error(`Form with ID "${formId}" not found`);
        }

        // Get the entry value directly from the hidden input
        const entryValue = document.getElementById(`entry_${entryCheck}`).value;
        if (!entryValue) {
            throw new Error('Entry value is required');
        }

        // Get station value (from your main form)
        const stationValue = document.getElementById('id_STATION')?.value || '';

        // Get all form values
        const shelfData = {
            entry: entryValue,
            floor: document.getElementById(`floor_${entryCheck}_${formNumber}_M`).value,
            M_Shelf: document.getElementById(`Shelf_${entryCheck}_${formNumber}_M`).value,
            M_Tray: document.getElementById(`Tray_${entryCheck}_${formNumber}_M`).value,
            M_Section: document.getElementById(`Section_${entryCheck}_${formNumber}_M`).value,
            Moisture: document.getElementById(`amount_${entryCheck}_${formNumber}_M`).value,
            Week: document.getElementById(`week_${entryCheck}_${formNumber}_M`).value,
            Date: document.getElementById(`date_${entryCheck}_${formNumber}_M`).value,
            station: stationValue,
            timestamp: new Date().toISOString()
        };

        // Validate required fields
        if (!shelfData.M_Shelf || !shelfData.M_Tray || !shelfData.M_Section || !shelfData.Moisture) {
            throw new Error('Missing required fields');
        }

        // Save to both IndexedDB stores
        const db = await openIndexedDB('GCNA', 2);
        const transaction = db.transaction(['M_Shelves'], 'readwrite');
        
        // // Save to In-House-Drying
        // const dryingStore = transaction.objectStore('In-House-Drying');
        // const dryingId = await getNextId(dryingStore);
        // await putData(dryingStore, { ...shelfData, id: dryingId });

        // Save to M_Shelves
        const shelvesStore = transaction.objectStore('M_Shelves');
        const shelvesId = await getNextId(shelvesStore);
        await putData(shelvesStore, { ...shelfData, id: shelvesId });

        console.log('Data saved successfully to both stores:', shelfData);
        alert('Data saved successfully to Moisture Shelves:', shelfData);
        
        transferIndexedDBData(); // Transfer to Django
        removeFormM(formId); // Remove the form after successful submission

    } catch (error) {
        console.error('Error in submitMForm:', error);
        // alert(`Error saving data: ${error.message}`);
    }
}

    function transferIndexedDBData() {
          var request = indexedDB.open('GCNA', 2);

          request.onsuccess = function(event) {
              var db = event.target.result;
              var transaction = db.transaction('M_Shelves', 'readonly');
              var objectStore = transaction.objectStore('M_Shelves');
              var getRequest = objectStore.getAll();

              getRequest.onsuccess = function(event) {
                  var data = event.target.result;
             
              };
          };

          request.onerror = function(event) {
              console.error('Error opening IndexedDB', event);
          };
      }


async function openIndexedDB(name, version) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(name, version);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject('Error opening DB');
    });
}

async function getNextId(store) {
    return new Promise((resolve) => {
        const req = store.openCursor(null, 'prev');
        req.onsuccess = (e) => {
            const cursor = e.target.result;
            resolve(cursor ? cursor.key + 1 : 1);
        };
    });
}

async function putData(store, data) {
    return new Promise((resolve, reject) => {
        const req = store.put(data);
        req.onsuccess = () => resolve();
        req.onerror = () => reject('Error saving data');
    });
}

function removeFormM(formId) {
    const form = document.getElementById(formId);
    if (form) {
        form.remove();
    }
}

const SHELF00 = [
    ['', '--Select Shelf--'],
    ['A', 'A'], ['B', 'B'], ['C', 'C'], ['D', 'D'],
    ['E', 'E'], ['F', 'F'], ['G', 'G'], ['H', 'H'],
    ['I', 'I'], ['J', 'J'], ['K', 'K'],         ['L', 'L'],
        ['M', 'M'],
        ['N', 'N'],
        ['O', 'O'],
        ['P', 'P'],
        ['Q', 'Q'],
        ['R', 'R'],
        ['S', 'S'],
        ['T', 'T'],
        ['U', 'U'],
        ['V', 'V'],
];

const TRAY00 = [
    ['', '--Select Tray--'],
    ['1', '1'], ['2', '2'], ['3', '3'], ['4', '4'], ['5', '5'],
    ['6', '6'],
];

const SECTION00 = [
    ['', '--Select Section--'],
    ['A', 'A'], ['B', 'B'], ['C', 'C'], ['D', 'D'], ['E', 'E'],
    ['F', 'F'], ['G', 'G'], ['H', 'H'], ['I', 'I'], ['J', 'J'],
    ['K', 'K'], ['L', 'L'], ['M', 'M'], ['N', 'N'], ['O', 'O'],
    ['P', 'P'], ['Q', 'Q'], ['R', 'R'], ['S', 'S'], ['T', 'T']
];

function generateOptions(options) {
    return options.map(option => `<option value="${option[0]}">${option[1]}</option>`).join('');
}

function updateSectionValue_M(entryCheck,formCountcheck) {
    const section1 = document.getElementById(`section1_${entryCheck}_${formCountcheck}_M`).value;
    const section2 = document.getElementById(`section2_${entryCheck}_${formCountcheck}_M`).value;
    document.getElementById(`Section_${entryCheck}_${formCountcheck}_M`).value = section1 && section2 ? `${section1}-${section2}` : '';
}



</script>









<script>
document.addEventListener('click', function(event) {
    if (event.target.id === 'shelvebtn') {
      event.preventDefault();
        const entryCheck = event.target.getAttribute('data-entry');
        const container = document.getElementById(`newShelves-${entryCheck}`);
        
        if (container) {
            addForm('newShelves', 'mainForm', container, entryCheck);
        } else {
            console.error(`Container not found for entryCheck: ${entryCheck}`);
        }
    }
});
function addForm(tableId, mainFormId, container, entryCheck) {
    event.preventDefault();
    formCount++;
    const form = document.createElement('form');
    form.id = `form_${formCount}_${entryCheck}`; 
    form.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Floor:</th>
                    <th scope="col">Shelf:</th>
                    <th scope="col">Tray:</th>
                    <th scope="col" colspan=2>Section:</th>
                    <th scope="col">Amount (number of bags)</th>
                    <th scope="col"></th>
                    <th scope="col"></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                  <td>
                        <select id="floor" class="form-control" name="floor" required>
                            <option value="">--Select Floor--</option>
                            <option value="Ground Floor">Ground Floor</option>
                            <option value="1st Floor">1st Floor</option>
                            <option value="2nd Floor">2nd Floor</option>
                            <option value="Floor Loft">Floor Loft</option>
                        </select>
                    </td>
                    <td>
                        <select id="Shelf_${entryCheck}_${formCount}" class="form-control" name="Shelf" required>
                            <option value="">--Select Shelf--</option>
                            ${generateOptions(SHELF0)}
                        </select>
                    </td>
                    <td>
                        <select id="Tray_${entryCheck}_${formCount}" class="form-control" name="Tray" required>
                            <option value="">--Select Tray--</option>
                            ${generateOptions(TRAY0)}
                        </select>
                    </td>
                    <td>
                        <select id="section1_${entryCheck}_${formCount}" class="form-control" name="section1" required onchange="updateSectionValue('${entryCheck}','${formCount}')">
                            <option value="">--Select Section--</option>
                            ${generateOptions(SECTION0)}
                        </select>
                    </td>
                    <td>
                        <select id="section2_${entryCheck}_${formCount}" class="form-control" name="section2" required onchange="updateSectionValue('${entryCheck}','${formCount}')">
                            <option value="">--Select Section--</option>
                            ${generateOptions(SECTION0)}
                        </select>
                        <input type="hidden" id="Section_${entryCheck}_${formCount}" name="Section">
                    </td>
                    <td>
                        <input type="text" id="amount_${entryCheck}_${formCount}" class="form-control" name="amount" required 
                           >
                    </td>
                    <td>
                        <button type="button" class="submit_contents" onclick="submitForm('${tableId}', '${mainFormId}', ${formCount}, '${entryCheck}')">âœ”</button>
                    </td>
                    <td>
                        <button type="button" class="addrow" onclick="removeForm('form_${formCount}_${entryCheck}')">Close</button>
                    </td>
                  
                </tr>
            </tbody>
        </table>
        <div style="display: none;">
            <input type="number" id="entry_${entryCheck}_${formCount}" name="entry" value="${entryCheck}" required>
            <input type="text" id="floor_${entryCheck}_${formCount}" name="floor" required>
            <input type="hidden" id="station_${entryCheck}_${formCount}" name="station" required>
        </div>
    `;
    container.appendChild(form);
}
// Example option lists
const SHELF0 = [
    ['', '--Select Shelf--'],
    ['A', 'A'], ['B', 'B'], ['C', 'C'], ['D', 'D'],
    ['E', 'E'], ['F', 'F'], ['G', 'G'], ['H', 'H'],
    ['I', 'I'], ['J', 'J'], ['K', 'K'], ['L', 'L']
];

const TRAY0 = [
    ['', '--Select Tray--'],
    ['1', '1'], ['2', '2'], ['3', '3'], ['4', '4'], ['5', '5'],
    ['6', '6'], ['7', '7'], ['8', '8'], ['9', '9'], ['10', '10']
];

const SECTION0 = [
    ['', '--Select Section--'],
    ['A', 'A'],
    ['B', 'B'],
    ['C', 'C'],
    ['D', 'D'],
    ['E', 'E'],
    ['F', 'F'],
    ['G', 'G'],
    ['H', 'H'],
    ['I', 'I'],
    ['J', 'J'],
    ['K', 'K'],
    ['L', 'L'],
    ['M', 'M'],
    ['N', 'N'],
    ['O', 'O'],
    ['P', 'P'],
    ['Q', 'Q'],
    ['R', 'R'],
    ['S', 'S'],
    ['T', 'T'],

];



function generateOptions(options) {
    return options.map(option => `<option value="${option[0]}">${option[1]}</option>`).join('');
}


// Update Section value for a specific entry
function updateSectionValue(entryCheck,formCount) {
    const section1 = document.getElementById(`section1_${entryCheck}_${formCount}`).value;
    const section2 = document.getElementById(`section2_${entryCheck}_${formCount}`).value;
    document.getElementById(`Section_${entryCheck}_${formCount}`).value = section1 && section2 ? `${section1}-${section2}` : '';
}



async function submitForm(tableId, mainFormId, formNumber, entryCheck) {
    try {
        const formId = `form_${formNumber}_${entryCheck}`;
        const form = document.getElementById(formId);
        
        if (!form) {
            throw new Error(`Form with ID "${formId}" not found`);
        }

        const formData = new FormData(form);
        formData.delete('csrfmiddlewaretoken');

        // Ensure entry matches the passed entryCheck value
        const entryValue = entryCheck || formData.get('entry');
        if (!entryValue) {
            throw new Error('Entry value is required');
        }

        // Get station value (assuming it's available in your form)
        const stationValue = document.getElementById('id_STATION')?.value || '';

        // Prepare data object with all form values
        const shelfData = {
            ...Object.fromEntries(formData.entries()),
            entry: entryValue,
            station: stationValue,
            // Add floor if available in form
            floor: formData.get('floor') || ''
        };

        // Save to IndexedDB
        const db = await openIndexedDB('GCNA', 2);
        const transaction = db.transaction(['Shelves'], 'readwrite');
        
        // Save to In-House-Drying
        // const dryingStore = transaction.objectStore('In-House-Drying');
        // shelfData.id = await getNextId(dryingStore);
        // await putData(dryingStore, shelfData);

        // Save to Shelves
        const shelvesStore = transaction.objectStore('Shelves');
        shelfData.id = await getNextId(shelvesStore);
        await putData(shelvesStore, shelfData);

        console.log('Shelf data saved successfully', shelfData);
        alert('Shelf data saved successfully', shelfData);
        transferIndexedDBData(); // Transfer to Django

    } catch (error) {
        console.error('Error in submitForm:', error);
    }
}

// Helper functions (make sure these are defined)
async function openIndexedDB(name, version) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(name, version);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject('Error opening DB');
    });
}

async function getNextId(store) {
    return new Promise((resolve) => {
        const req = store.openCursor(null, 'prev');
        req.onsuccess = (e) => {
            const cursor = e.target.result;
            resolve(cursor ? cursor.key + 1 : 1);
        };
    });
}

async function putData(store, data) {
    return new Promise((resolve, reject) => {
        const req = store.put(data);
        req.onsuccess = () => resolve();
        req.onerror = () => reject('Error saving data');
    });
}

</script>

<script>

var formCount = 0;

document.addEventListener("DOMContentLoaded", function () {
    let openRequest3 = indexedDB.open("GCNA");

    openRequest3.onsuccess = function (event) {
        let db = event.target.result;
        let transaction = db.transaction("M_Shelves", "readonly");
        let landInfoStore = transaction.objectStore("M_Shelves");
        let getAllRequest = landInfoStore.getAll();

        getAllRequest.onsuccess = function (event) {
            let landInfoRecords = event.target.result;
            
            // Find all entryCheck elements (both visible and hidden)
            document.querySelectorAll('[id="entryCheck"], [id^="newentryCheck"]').forEach(entryCheckTd => {
                let entryValue = entryCheckTd.textContent.trim();
                let matchingRecords = landInfoRecords.filter(record => record.entry === entryValue);
                
                if (matchingRecords.length > 0) {
                    // Find the container where we should add moisture data
                    let container = entryCheckTd.closest('form').querySelector('#landInfoData2');
                    if (!container) {
                        // If landInfoData2 doesn't exist, create it after the moisture button
                        let moistureBtn = entryCheckTd.closest('form').querySelector('[id^="moisturebtn"]');
                        if (moistureBtn) {
                            container = document.createElement('div');
                            container.id = 'landInfoData2';
                            moistureBtn.parentNode.insertBefore(container, moistureBtn.nextSibling);
                        }
                    }
                    
                    if (container) {
                        // Clear previous content to avoid duplicates
                        container.innerHTML = '';
                        
                        matchingRecords.forEach(record => {
                            let entryContainer = document.createElement("div");
                            entryContainer.className = "entry-container";
                            entryContainer.innerHTML = `
                                <table class="table">
                                    <h5 class="card-title">${record.floor || ''}</h5>
                                    <thead>
                                        <tr>
                                            <th scope="col">Shelf</th>
                                            <th scope="col">Tray</th>
                                            <th scope="col">Section</th>
                                            <th scope="col">Moisture</th>
                                            <th scope="col">Week</th>
                                            <th scope="col">Date</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                       <tr class="original-entry" data-record-id="${record.id}">
                                            <td><input type="text" class="form-control shelf-input" value="${record.M_Shelf || ''}" required onblur="saveOnBlur(this, '${record.id}', 'M_Shelf')"></td>
                                            <td><input type="text" class="form-control tray-input" value="${record.M_Tray || ''}" required onblur="saveOnBlur(this, '${record.id}', 'M_Tray')"></td>
                                            <td><input type="text" class="form-control section-input" value="${record.M_Section || ''}" required onblur="saveOnBlur(this, '${record.id}', 'M_Section')"></td>
                                            <td><input type="text" class="form-control moisture-input" value="${record.Moisture || ''}" required onblur="saveOnBlur(this, '${record.id}', 'Moisture')"></td>
                                            <td><input type="text" class="form-control week-input" value="${record.Week || ''}" required onblur="saveOnBlur(this, '${record.id}', 'Week')"></td>
                                            <td><input type="date" class="form-control date-input" value="${record.Date || ''}" required onblur="saveOnBlur(this, '${record.id}', 'Date')"></td>
                                                   <td>
                                            </td>
                                                                                        <td>

 <button class="btn btn-danger" onclick="deleteMoistureEntry('${record.id}', this)">Delete</button>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                                <br><br><br>`;
                            container.appendChild(entryContainer);
                        });
                    }
                }
            });
        };
        
        getAllRequest.onerror = function(event) {
            console.error("Error fetching records from M_Shelves:", event.target.error);
        };
    };
    
    openRequest3.onerror = function(event) {
        console.error("Error opening IndexedDB:", event.target.error);
    };
});


function deleteMoistureEntry(recordId, btn) {
    if (!confirm("Are you sure you want to delete this record?")) return;

    let openRequest = indexedDB.open("GCNA");

    openRequest.onerror = function () {
        console.error("Failed to open IndexedDB");
    };

    openRequest.onsuccess = function (event) {
        let db = event.target.result;

        // ðŸ”‘ MUST be readwrite to delete
        let transaction = db.transaction("M_Shelves", "readwrite");
        let store = transaction.objectStore("M_Shelves");

        let deleteRequest = store.delete(Number(recordId));

        deleteRequest.onsuccess = function () {
            console.log("Record deleted from IndexedDB:", recordId);

            // âœ… Remove from UI
            const entryContainer = btn.closest(".entry-container");
            if (entryContainer) {
                entryContainer.remove();
            }
        };

        deleteRequest.onerror = function () {
            console.error("Failed to delete record:", recordId);
        };

        transaction.oncomplete = function () {
            db.close();
        };
    };
}


function saveOnBlur(inputElement, recordId, propertyName) {
    let newValue = inputElement.value;

    let openRequest = indexedDB.open("GCNA");

    openRequest.onsuccess = function (event) {
        let db = event.target.result;
        let transaction = db.transaction("M_Shelves", "readwrite");
        let landInfoStore = transaction.objectStore("M_Shelves");
        let getRequest = landInfoStore.get(parseInt(recordId));

        getRequest.onsuccess = function (event) {
            let record = event.target.result;
            if (record) {
                record[propertyName] = newValue; // Dynamically update the property

                let updateRequest = landInfoStore.put(record);

                updateRequest.onsuccess = function () {
                    console.log(`Record with ID ${recordId} - ${propertyName} updated to: ${newValue}`);
                    // Optionally provide visual feedback (e.g., briefly change background color)
                    inputElement.classList.add('saved');
                    setTimeout(() => {
                        inputElement.classList.remove('saved');
                    }, 1000);
                };

                updateRequest.onerror = function (event) {
                    console.error(`Error updating record with ID ${recordId} - ${propertyName}:`, event.target.error);
                    // Optionally provide error feedback
                    inputElement.classList.add('error');
                    setTimeout(() => {
                        inputElement.classList.remove('error');
                    }, 1000);
                };
            } else {
                console.log(`Record with ID ${recordId} not found.`);
            }
        };

        getRequest.onerror = function (event) {
            console.error(`Error getting record with ID ${recordId}:`, event.target.error);
        };

        transaction.oncomplete = function () {
            db.close();
        };

        transaction.onerror = function (event) {
            console.error("Transaction error:", event.target.error);
        };
    };

    openRequest.onerror = function (event) {
        console.error("Error opening IndexedDB:", event.target.error);
    };
}



// Add this delete function

function saveEntry(buttonElement, recordId) {
    let row = buttonElement.closest('tr');
    let shelf = row.querySelector('.shelf-input').value;
    let tray = row.querySelector('.tray-input').value;
    let section = row.querySelector('.section-input').value;
    let moisture = row.querySelector('.moisture-input').value;
    let week = row.querySelector('.week-input').value;
    let date = row.querySelector('.date-input').value;

    let openRequest = indexedDB.open("GCNA");

    openRequest.onsuccess = function (event) {
        let db = event.target.result;
        let transaction = db.transaction("M_Shelves", "readwrite");
        let landInfoStore = transaction.objectStore("M_Shelves");
        let getRequest = landInfoStore.get(parseInt(recordId)); // Assuming record ID is an integer

        getRequest.onsuccess = function (event) {
            let record = event.target.result;
            if (record) {
                record.M_Shelf = shelf;
                record.M_Tray = tray;
                record.M_Section = section;
                record.Moisture = moisture;
                record.Week = week;
                record.Date = date;

                let updateRequest = landInfoStore.put(record);

                updateRequest.onsuccess = function () {
                    console.log(`Record with ID ${recordId} updated successfully.`);
                    // Optionally provide user feedback, e.g., by changing the button text
                    buttonElement.textContent = 'Saved!';
                    setTimeout(() => {
                        buttonElement.textContent = 'Save';
                    }, 1500);
                };

                updateRequest.onerror = function (event) {
                    console.error(`Error updating record with ID ${recordId}:`, event.target.error);
                    // Optionally provide error feedback to the user
                    buttonElement.textContent = 'Error Saving';
                    setTimeout(() => {
                        buttonElement.textContent = 'Save';
                    }, 1500);
                };
            } else {
                console.log(`Record with ID ${recordId} not found.`);
                // Optionally handle the case where the record doesn't exist
            }
        };

        getRequest.onerror = function (event) {
            console.error(`Error getting record with ID ${recordId}:`, event.target.error);
        };

        transaction.oncomplete = function () {
            db.close();
        };

        transaction.onerror = function (event) {
            console.error("Transaction error:", event.target.error);
        };
    };

    openRequest.onerror = function (event) {
        console.error("Error opening IndexedDB:", event.target.error);
    };
}

  
  
  function duplicateEntry(button, shelf, tray, section, entry, labelText) {
      formCount++;
      var currentDate = new Date().toISOString().split('T')[0];
  
      var duplicateRow = `
      <tr class="duplicate-entry">
          <td><input type="text" class="form-control" name="M_Shelf" value="${shelf}" required></td>
          <td><input type="text" class="form-control" name="M_Tray" value="${tray}" required></td>
          <td><input type="text" class="form-control" name="M_Section" value="${section}" required></td>
          <td><input type="text" class="form-control" name="Moisture" value="" required></td>
          <td><input type="text" class="form-control" name="Week" value="" required></td>
          <td><input type="date" class="form-control" name="Date" value="${currentDate}" required></td>
          <td>
              <button type="button" class="submit_contents" onclick="submitDuplicateForm(this, '${shelf}', '${tray}', '${section}', '${entry}', '${labelText}')">âœ”</button>
              <button type="button" class="addrow" onclick="removeForm(this)">Close</button>
          </td>
      </tr>`;
  
      let originalRow = button.closest("tr");
      originalRow.insertAdjacentHTML("afterend", duplicateRow);
  }
  
  function removeForm(button) {
      button.closest("tr").remove();
  }
  
  function submitDuplicateForm(button, shelf, tray, section, entry, labelText) {
      let row = button.closest("tr");
      let formData = {
          M_Shelf: row.querySelector('input[name="M_Shelf"]').value,
          M_Tray: row.querySelector('input[name="M_Tray"]').value,
          M_Section: row.querySelector('input[name="M_Section"]').value,
          Moisture: row.querySelector('input[name="Moisture"]').value,
          Week: row.querySelector('input[name="Week"]').value,
          Date: row.querySelector('input[name="Date"]').value,
          entry: entry,
          floor: labelText
      };
  
      let request = indexedDB.open("GCNA", 2);
  
      request.onsuccess = function (event) {
          let db = event.target.result;
          let transaction = db.transaction("M_Shelves", "readwrite");
          let objectStore = transaction.objectStore("M_Shelves");
  
          let highestIdRequest = objectStore.openCursor(null, "prev");
          highestIdRequest.onsuccess = function (event) {
              let cursor = event.target.result;
              if (cursor) {
                  formData.id = cursor.key + 1;
              } else {
                  formData.id = 1; // First entry
              }
  
              let addRequest = objectStore.add(formData);
  
              addRequest.onsuccess = function () {
                  console.log("Duplicate entry added to IndexedDB successfully");
                  alert("Duplicate entry saved successfully!");
              };
  
              addRequest.onerror = function () {
                  console.error("Error adding duplicate entry to IndexedDB");
              };
          };
      };
  
      request.onerror = function (event) {
          console.error("Error opening IndexedDB", event);
      };
  }
  </script>



  {% endblock %}
</body>
