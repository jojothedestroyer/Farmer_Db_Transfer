{% extends 'gcna/base.html' %} {% block content%}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* General Styles */
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7; /* Adjusted background color */
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .card {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .card-body {
      padding: 20px;
    }

    h4 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th,
    td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      font-weight: bold;
      color: #555;
    }

    td {
      color: #777;
    }

    button {
      cursor: pointer;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: #fff;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    /* Form Styles */
    record {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 16px;
      color: #333;
      outline: none;
    }

    #saveButton,
    #closeButton {
      margin-top: 10px;
      background-color: #28a745;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #closeButton {
      background-color: #dc3545;
      margin-left: 10px;
    }

    /* Responsive Styles */
    @media screen and (max-width: 768px) {
      .container {
        max-width: 90%;
      }
    }
  </style>







 


<style>
  .table {
      width: 100%;
      border-collapse: collapse;
      background-color: #ffffff;
      font-family: Raleway;
      border-radius: 10px;
      /* box-shadow: 0 2px 25px rgba(0, 0, 0, 0.2); */
  }

  .table th, .table td {
      padding: 10px;
      text-align: center;
      border: 1px solid #e4e4e4;
      min-width: 150px; /* Ensure cells have a minimum width */
  }

  .table th {
      background-color: #f8f9fa;
      font-weight: bold;
  }

  .form-control {
      width: 100%; /* Full width of the cell */
      min-width: 150px; /* Minimum width for dropdowns and inputs */
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px; /* Ensure text is readable */
  }

  .add-row, .submit_contents {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      font-size: 14px; /* Ensure button text is readable */
  }

  .add-row:hover, .submit_contents:hover {
      background-color: #0056b3;
  }



  
  .addrow, .submit_contents {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      font-size: 14px; /* Ensure button text is readable */
  }

  .addrow:hover, .submit_contents:hover {
      background-color: #0056b3;
  }
#entryCheck{
  display: none;
}
  .hidden-label1 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      display: block;
  }

  /* Ensure the table is responsive */
  @media (max-width: 768px) {
      .table th, .table td {
          min-width: 120px; /* Adjust for smaller screens */
      }

      .form-control {
          min-width: 120px; /* Adjust for smaller screens */
          font-size: 12px; /* Smaller font size for smaller screens */
      }

      .add-row, .submit_contents {
          font-size: 12px; /* Smaller font size for smaller screens */
      }
  }
</style>













</head>
<body>
  <div class="container"></div>

  <div id="landInfoData"></div>

  <script>
    let openRequest = indexedDB.open("GCNA");
    let fieldBlacklist = [];
    const fieldBlacklistConfig = {
      DATE_OF_SAMPLING: true, // Set to true to blacklist if null or empty
      DECISION: true,
      Quantity_of_Bags: true,    };
    openRequest.onsuccess = function (event) {
      let db = event.target.result;
      let transaction = db.transaction("In-House-Drying", "readonly");
      let landInfoStore = transaction.objectStore("In-House-Drying");
      let getAllRequest = landInfoStore.getAll();

      getAllRequest.onsuccess = function (event) {
        let landInfoRecords = event.target.result;
        let landInfoDataDiv = document.getElementById("landInfoData");

        landInfoRecords.forEach((record) => {
          let entryContainer = document.createElement("div");
          entryContainer.id = `entryContainer_${record.id}`;
          entryContainer.innerHTML = `
       <form>
  <div class="card">
    <div class="card-body">
      <p class="card-text">
        <table id="vertical-1" class="table table-hover table-light">
          <tr>
            <th>Station</th>
            <td>${record.STATION}</td>
          </tr>  
          <tr>
            <th>Date of Purchase</th>
            <td>${record.DATE_OF_PURCHASE}</td>
          </tr>
          <tr>
            <th>Place of Purchase</th>
            <td>${record.PLACE_OF_PURCHASE}</td>
          </tr>
          <tr>
            <th>Number of Farmers</th>
            <td>${record.TOTAL_NUM_OF_FARMERS}</td>
          </tr>
          <tr>
            <th>Number of Bags</th>
            <td>${record.NUM_OF_BAGS}</td>
          </tr>
          <tr style="display: none;">
            <td id="entryCheck">${record.entryCheck}</td>
          </tr>
          <tr>
            <th>Total Nutmegs bought (lbs)</th>
            <td>${record.TOTAL_LBS_NUTMEG_BOUGHT}</td>
          </tr>
          <tr>
            <th>Complete</th>
            <td>
              <button onclick="saveEditedCompletion(${record.id}, 'Yes')">Entry Complete?</button>
            </td>
          </tr>
          <!-- Dates table wrapped inside a row -->
          <tr>
            <td colspan="2">
              <label>Dates</label>
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Start Drying Date</th>
                    <th scope="col">Approximate End Drying Date</th>
                    <th scope="col">End Drying Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><input type="date" class="form-control" value="${record.START_DRYING_DATE}" onchange="saveEditedDate2(${record.id}, this.value)"></td>
                    <td><input type="date" class="form-control" id="date-${record.id}" value="${record.APPROX_END_DRYING_DATE}" readonly></td>
                    <td><input type="date" class="form-control" value="${record.END_DRYING_DATE}" onchange="saveEditedDate(${record.id}, this.value)"></td>
                  </tr>
                </tbody>
              </table>
            </td>
          </tr>
        </table>

        <center>
          <button id="shelvebtn" data-entry="${record.entryCheck}">Add Shelves</button>
        </center>

        <br/><br/>

        <div id="newShelves-${record.entryCheck}"></div>
        <div id="landInfoData1"></div>

<br>  
<br>  
<br>  
<br>  
<br>  
<br>  




                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           












 
 <tr>

         <center>
            <p>MOISTURE TESTING (Weeks 3, 6, 8)</p>
        <center>
                   <center>

          <button id="moisturebtn" data-entry="${record.entryCheck}">Add Moisture Row</button>
        </center>
        <tr style="display: none;">
            <div id="newMoistureShelves-${record.entryCheck}"></div>
          </tr>



<div id="landInfoData2"></div>


</center>
        </tr>


        <tr>

    
<br>  
<br>  
<br>  
<br>  
<br>  
<br>  







<tr>

         <center>

</center>
        </tr>



<table class="table" >

    <center>
<label class="hidden-label5">MONITORING AND INSPECTION</label>   
 </center> 
  <thead>
    <tr>
      <th scope="col">Station</th>
      <th scope="col">Location</th>
      <th scope="col">Defect</th>
      <th scope="col">Predominant Defect</th>
     </tr>
  </thead>
  <tbody>
    <tr>
      <td>${record.STATION2}</td>
      <td>${record.LOCATION3}</td>
      <td>${record.DEFECT}</td>
      <td>${record.PREDOMINANT_DEFECT}</td>
 
    </tr>

  </tbody>

</table>

<table>




</table>











































<table class="table">

    <center>
 </center> 
  <thead>

  </thead>
  <tbody>
    <tr>


       <td>ALERT</td>
      <td>${record.ALERT}</td>

    </tr>

  </tbody>
</table>





         <table id="vertical-1" class="table table-hover table-light">



        <tr>
            <th>Sampling from Gouyvae</th>
            <td>${record.Sampling_from_gouyvae}</td>
        </tr>


<br>


        <tr>
            <th>Control Number</th>
            <td>${record.Control_number}</td>
        </tr>
</table>




















                


            </div>
               </div>
               </form>

                              <br> <br> <br>

           `;
           if (
            record.COMPLETE == null ||
            record.COMPLETE == "" ||
            record.COMPLETE == "null" ||
            record.COMPLETE == "N" ||
            record.COMPLETE == "n" ||
            record.COMPLETE == "No" ||
            record.COMPLETE == "no"
          ) {
            landInfoDataDiv.appendChild(entryContainer);
          }
        });
      };
    };
    function saveEditedDate(id, newDate) {
      let openRequestup = indexedDB.open("GCNA");

      openRequestup.onsuccess = function (event) {
        let db1 = event.target.result;
        let transaction = db1.transaction("In-House-Drying", "readwrite");
        let landInfoStore = transaction.objectStore("In-House-Drying");
        let getRequest = landInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;
          record.END_DRYING_DATE = newDate;

          let updateRequest = landInfoStore.put(record);
          updateRequest.onsuccess = function () {
            console.log("End Drying Date updated successfully!");
          };
        };
      };
    }





    function saveEditedDate2(id, newDate) {
  let openRequestup = indexedDB.open("GCNA");

  openRequestup.onsuccess = function (event) {
    let db1 = event.target.result;
    let transaction = db1.transaction("In-House-Drying", "readwrite");
    let landInfoStore = transaction.objectStore("In-House-Drying");
    let getRequest = landInfoStore.get(id);

    getRequest.onsuccess = function (event) {
      let record = event.target.result;
      if (record) {
        let startDate = new Date(newDate); // Convert newDate to Date object
        let newerDate = new Date(startDate); // Clone startDate
        newerDate.setDate(newerDate.getDate() + 42); // Add 6 weeks (42 days)

        // Store as YYYY-MM-DD format
        record.START_DRYING_DATE = startDate.toISOString().split("T")[0];
        record.APPROX_END_DRYING_DATE = newerDate.toISOString().split("T")[0];

        let updateRequest = landInfoStore.put(record);
        updateRequest.onsuccess = function () {
          console.log("Start Drying Date and Approx End Drying Date updated successfully!");

          // Update the UI immediately
          let dateInput = document.querySelector(`#date-${id}`);
          if (dateInput) {
            dateInput.value = record.APPROX_END_DRYING_DATE;
          }
        };
      } else {
        console.log("Record not found for ID:", id);
      }
    };
  };
}



    // function saveEditedDate3(id, newDate) {
    //   let openRequestup = indexedDB.open("GCNA");

    //   openRequestup.onsuccess = function (event) {
    //     let db1 = event.target.result;
    //     let transaction = db1.transaction("In-House-Drying", "readwrite");
    //     let landInfoStore = transaction.objectStore("In-House-Drying");
    //     let getRequest = landInfoStore.get(id);

    //     getRequest.onsuccess = function (event) {
    //       let record = event.target.result;
          // record.APPROX_END_DRYING_DATE = newerDate;

    //       let updateRequest = landInfoStore.put(record);
    //       updateRequest.onsuccess = function () {
    //         console.log("Approximate End Drying Date updated successfully!");
    //       };
    //     };
    //   };
    // }




    function saveEditedCompletion(id, completion) {
      let openRequestup = indexedDB.open("GCNA");

      openRequestup.onsuccess = function (event) {
        let db1 = event.target.result;
        let transaction = db1.transaction("In-House-Drying", "readwrite");
        let landInfoStore = transaction.objectStore("In-House-Drying");
        let getRequest = landInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;
          record.COMPLETE = completion;

          let updateRequest = landInfoStore.put(record);
          updateRequest.onsuccess = function () {
            console.log("End Drying Date updated successfully!");
          };
        };
      };
    };
  </script>
<script>
    let openRequest2 = indexedDB.open("GCNA");

    openRequest2.onsuccess = function (event) {
      let db = event.target.result;
      let transaction = db.transaction("Shelves", "readonly");
      let landInfoStore = transaction.objectStore("Shelves");
      let getAllRequest = landInfoStore.getAll();

      getAllRequest.onsuccess = function (event) {
        let landInfoRecords = event.target.result;
        let tables = document.querySelectorAll(".table"); // Select all tables

        // Clear existing landInfoData1 divs first to avoid duplicates
        tables.forEach(table => {
          let existingDiv = table.querySelector(".landInfoData1");
          if (existingDiv) {
            existingDiv.remove();
          }
        });

        // Iterate through each table first
        tables.forEach((table) => {
          let entryCheckTd = table.querySelector("td#entryCheck");
          if (!entryCheckTd) return; // Skip if no entryCheck td found
          
          let entryValue = entryCheckTd.textContent.trim();
          
          // Create container div for this table's records
          let landInfoDataDiv = document.createElement("div");
          landInfoDataDiv.className = "landInfoData1";
          table.appendChild(landInfoDataDiv);
          
          // Filter records for this entry value
          let matchingRecords = landInfoRecords.filter(record => record.entry === entryValue);
          
          // Add each matching record to the table
          matchingRecords.forEach((record) => {
            let entryContainer = document.createElement("div");
            entryContainer.className = "entry-container";
            entryContainer.dataset.formId = table.id;
            entryContainer.innerHTML = `





  <table class="table">
                               <center>       <h5 class="card-title">${record.floor}</h5>     </center>       

            <thead>
                                    <tr>
                                        <th scope="col">Shelf</th>
                                        <th scope="col">Tray</th>
                                        <th scope="col">Section</th>
                                        <th scope="col">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                      
                                        <td>${record.Shelf}</td>
                                        <td>${record.Tray}</td>
                                        <td>${record.Section}</td>
                                        <td>${record.amount}</td>

                                    </tr>
<tr style="display: none;"> <td style="opacity: 0;">${record.floor}</td>
                                        <td style="opacity: 0;">${record.entry}</td>
                                        <td style="opacity: 0;">${record.station}</td></tr>
                                </tbody>
                            </table>

                     `;
            landInfoDataDiv.appendChild(entryContainer);
          });
        });
      };
    };
</script>



<script>
document.addEventListener('click', function(event) {
    if (event.target.id === 'moisturebtn') {
        event.preventDefault();
        const entryCheck = event.target.getAttribute('data-entry');
        const container = document.getElementById(`newMoistureShelves-${entryCheck}`);
        
        if (container) {
            addMForm('newMoistureShelves', 'mainForm', container, entryCheck);
        } else {
            console.error(`Container not found for entryCheck: ${entryCheck}`);
        }
    }
});

function addMForm(tableId, mainFormId, container, entryCheck) {
    formCount++;
    const form = document.createElement('form');
    form.id = `form_${formCount}_${entryCheck}`;
    form.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Floor:</th>
                    <th scope="col">Shelf:</th>
                    <th scope="col">Tray:</th>
                    <th scope="col" colspan=2>Section:</th>
                    <th scope="col">Moisture</th>
                    <th>Week</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                  <td>
                        <select id="floor_${entryCheck}" class="form-control" name="floor" required>
                            <option value="">--Select Floor--</option>
                            <option value="Ground Floor">Ground Floor</option>
                            <option value="1st Floor">1st Floor</option>
                            <option value="2nd Floor">2nd Floor</option>
                            <option value="Floor Loft">Floor Loft</option>
                        </select>
                    </td>
                    <td>
                        <select id="Shelf_${entryCheck}" class="form-control" name="M_Shelf" required>
                            <option value="">--Select Shelf--</option>
                            ${generateOptions(SHELF00)}
                        </select>
                    </td>
                    <td>
                        <select id="Tray_${entryCheck}" class="form-control" name="M_Tray" required>
                            <option value="">--Select Tray--</option>
                            ${generateOptions(TRAY00)}
                        </select>
                    </td>
                    <td>
                        <select id="section1_${entryCheck}" class="form-control" name="section1" required onchange="updateSectionValue('${entryCheck}')">
                            <option value="">--Select Section--</option>
                            ${generateOptions(SECTION00)}
                        </select>
                    </td>
                    <td>
                        <select id="section2_${entryCheck}" class="form-control" name="section2" required onchange="updateSectionValue('${entryCheck}')">
                            <option value="">--Select Section--</option>
                            ${generateOptions(SECTION00)}
                        </select>
                        <input type="hidden" id="Section_${entryCheck}" name="M_Section">
                    </td>
                    <td>
                        <input type="text" id="amount_${entryCheck}" class="form-control" name="Moisture" required>
                    </td>
                    <td>
                        <input type="text" id="week_${entryCheck}" class="form-control" name="Week" required>
                    </td>
                    <td>
                        <input type="date" value="${new Date().toISOString().split('T')[0]}" id="date_${entryCheck}" class="form-control" name="Date" required>
                    </td>
                    <td>
                        <button type="button" class="submit_contents" onclick="submitMForm('${tableId}', '${mainFormId}', ${formCount}, '${entryCheck}')">✔</button>
                    </td>
                    <td>
                        <button type="button" class="addrow" onclick="removeForm('form_${formCount}_${entryCheck}')">Close</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div>
            <input type="hidden" id="entry_${entryCheck}" name="entry" value="${entryCheck}">
            <input type="hidden" id="station_${entryCheck}" name="station">
        </div>
    `;
    container.appendChild(form);
}

async function submitMForm(tableId, mainFormId, formNumber, entryCheck) {
    try {
        const formId = `form_${formNumber}_${entryCheck}`;
        const form = document.getElementById(formId);
        
        if (!form) {
            throw new Error(`Form with ID "${formId}" not found`);
        }

        // Get the entry value directly from the hidden input
        const entryValue = document.getElementById(`entry_${entryCheck}`).value;
        if (!entryValue) {
            throw new Error('Entry value is required');
        }

        // Get station value (from your main form)
        const stationValue = document.getElementById('id_STATION')?.value || '';

        // Get all form values
        const shelfData = {
            entry: entryValue,
            floor: document.getElementById(`floor_${entryCheck}`).value,
            M_Shelf: document.getElementById(`Shelf_${entryCheck}`).value,
            M_Tray: document.getElementById(`Tray_${entryCheck}`).value,
            M_Section: document.getElementById(`Section_${entryCheck}`).value,
            Moisture: document.getElementById(`amount_${entryCheck}`).value,
            Week: document.getElementById(`week_${entryCheck}`).value,
            Date: document.getElementById(`date_${entryCheck}`).value,
            station: stationValue,
            timestamp: new Date().toISOString()
        };

        // Validate required fields
        if (!shelfData.M_Shelf || !shelfData.M_Tray || !shelfData.M_Section || !shelfData.Moisture) {
            throw new Error('Missing required fields');
        }

        // Save to both IndexedDB stores
        const db = await openIndexedDB('GCNA', 2);
        const transaction = db.transaction(['M_Shelves'], 'readwrite');
        
        // // Save to In-House-Drying
        // const dryingStore = transaction.objectStore('In-House-Drying');
        // const dryingId = await getNextId(dryingStore);
        // await putData(dryingStore, { ...shelfData, id: dryingId });

        // Save to M_Shelves
        const shelvesStore = transaction.objectStore('M_Shelves');
        const shelvesId = await getNextId(shelvesStore);
        await putData(shelvesStore, { ...shelfData, id: shelvesId });

        console.log('Data saved successfully to both stores:', shelfData);
        transferIndexedDBData(); // Transfer to Django
        removeForm(formId); // Remove the form after successful submission

    } catch (error) {
        console.error('Error in submitMForm:', error);
        // alert(`Error saving data: ${error.message}`);
    }
}

    function transferIndexedDBData() {
          var request = indexedDB.open('GCNA', 2);

          request.onsuccess = function(event) {
              var db = event.target.result;
              var transaction = db.transaction('M_Shelves', 'readonly');
              var objectStore = transaction.objectStore('M_Shelves');
              var getRequest = objectStore.getAll();

              getRequest.onsuccess = function(event) {
                  var data = event.target.result;
             
              };
          };

          request.onerror = function(event) {
              console.error('Error opening IndexedDB', event);
          };
      }


// Helper functions
async function openIndexedDB(name, version) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(name, version);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject('Error opening DB');
    });
}

async function getNextId(store) {
    return new Promise((resolve) => {
        const req = store.openCursor(null, 'prev');
        req.onsuccess = (e) => {
            const cursor = e.target.result;
            resolve(cursor ? cursor.key + 1 : 1);
        };
    });
}

async function putData(store, data) {
    return new Promise((resolve, reject) => {
        const req = store.put(data);
        req.onsuccess = () => resolve();
        req.onerror = () => reject('Error saving data');
    });
}

function removeForm(formId) {
    const form = document.getElementById(formId);
    if (form) {
        form.remove();
    }
}

// Example option lists
const SHELF00 = [
    ['', '--Select Shelf--'],
    ['A', 'A'], ['B', 'B'], ['C', 'C'], ['D', 'D'],
    ['E', 'E'], ['F', 'F'], ['G', 'G'], ['H', 'H'],
    ['I', 'I'], ['J', 'J'], ['K', 'K'], ['L', 'L']
];

const TRAY00 = [
    ['', '--Select Tray--'],
    ['1', '1'], ['2', '2'], ['3', '3'], ['4', '4'], ['5', '5'],
    ['6', '6'], ['7', '7'], ['8', '8'], ['9', '9'], ['10', '10']
];

const SECTION00 = [
    ['', '--Select Section--'],
    ['A', 'A'], ['B', 'B'], ['C', 'C'], ['D', 'D'], ['E', 'E'],
    ['F', 'F'], ['G', 'G'], ['H', 'H'], ['I', 'I'], ['J', 'J'],
    ['K', 'K'], ['L', 'L'], ['M', 'M'], ['N', 'N'], ['O', 'O'],
    ['P', 'P'], ['Q', 'Q'], ['R', 'R'], ['S', 'S'], ['T', 'T']
];

function generateOptions(options) {
    return options.map(option => `<option value="${option[0]}">${option[1]}</option>`).join('');
}

function updateSectionValue(entryCheck) {
    const section1 = document.getElementById(`section1_${entryCheck}`).value;
    const section2 = document.getElementById(`section2_${entryCheck}`).value;
    document.getElementById(`Section_${entryCheck}`).value = section1 && section2 ? `${section1}-${section2}` : '';
}
</script>









<script>
document.addEventListener('click', function(event) {
    if (event.target.id === 'shelvebtn') {
      event.preventDefault(); // Prevent default action if needed
        const entryCheck = event.target.getAttribute('data-entry');
        const container = document.getElementById(`newShelves-${entryCheck}`);
        
        if (container) {
            addForm('newShelves', 'mainForm', container, entryCheck);
        } else {
            console.error(`Container not found for entryCheck: ${entryCheck}`);
        }
    }
});
function addForm(tableId, mainFormId, container, entryCheck) {
    formCount++;
    const form = document.createElement('form');
    form.id = `form_${formCount}_${entryCheck}`; // Unique ID per entry
    form.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Floor:</th>
                    <th scope="col">Shelf:</th>
                    <th scope="col">Tray:</th>
                    <th scope="col" colspan=2>Section:</th>
                    <th scope="col">Amount (number of bags)</th>
                    <th scope="col"></th>
                    <th scope="col"></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                  <td>
                        <select id="floor" class="form-control" name="floor" required>
                            <option value="">--Select Floor--</option>
                            <option value="Ground Floor">Ground Floor</option>
                            <option value="1st Floor">1st Floor</option>
                            <option value="2nd Floor">2nd Floor</option>
                            <option value="Floor Loft">Floor Loft</option>
                        </select>
                    </td>
                    <td>
                        <select id="Shelf_${entryCheck}" class="form-control" name="Shelf" required>
                            <option value="">--Select Shelf--</option>
                            ${generateOptions(SHELF0)}
                        </select>
                    </td>
                    <td>
                        <select id="Tray_${entryCheck}" class="form-control" name="Tray" required>
                            <option value="">--Select Tray--</option>
                            ${generateOptions(TRAY0)}
                        </select>
                    </td>
                    <td>
                        <select id="section1_${entryCheck}" class="form-control" name="section1" required onchange="updateSectionValue('${entryCheck}')">
                            <option value="">--Select Section--</option>
                            ${generateOptions(SECTION0)}
                        </select>
                    </td>
                    <td>
                        <select id="section2_${entryCheck}" class="form-control" name="section2" required onchange="updateSectionValue('${entryCheck}')">
                            <option value="">--Select Section--</option>
                            ${generateOptions(SECTION0)}
                        </select>
                        <input type="hidden" id="Section_${entryCheck}" name="Section">
                    </td>
                    <td>
                        <input type="text" id="amount_${entryCheck}" class="form-control" name="amount" required 
                            onblur="checkAmountAndTrigger(this.parentNode.parentNode, '${entryCheck}')">
                    </td>
                    <td>
                        <button type="button" class="submit_contents" onclick="submitForm('${tableId}', '${mainFormId}', ${formCount}, '${entryCheck}')">✔</button>
                    </td>
                    <td>
                        <button type="button" class="addrow" onclick="removeForm('form_${formCount}_${entryCheck}')">Close</button>
                    </td>
                  
                </tr>
            </tbody>
        </table>
        <div style="display: none;">
            <input type="number" id="entry_${entryCheck}" name="entry" value="${entryCheck}" required>
            <input type="text" id="floor_${entryCheck}" name="floor" required>
            <input type="hidden" id="station_${entryCheck}" name="station" required>
        </div>
    `;
    container.appendChild(form);
}
// Example option lists
const SHELF0 = [
    ['', '--Select Shelf--'],
    ['A', 'A'], ['B', 'B'], ['C', 'C'], ['D', 'D'],
    ['E', 'E'], ['F', 'F'], ['G', 'G'], ['H', 'H'],
    ['I', 'I'], ['J', 'J'], ['K', 'K'], ['L', 'L']
];

const TRAY0 = [
    ['', '--Select Tray--'],
    ['1', '1'], ['2', '2'], ['3', '3'], ['4', '4'], ['5', '5'],
    ['6', '6'], ['7', '7'], ['8', '8'], ['9', '9'], ['10', '10']
];

const SECTION0 = [
    ['', '--Select Section--'],
    ['A', 'A'],
    ['B', 'B'],
    ['C', 'C'],
    ['D', 'D'],
    ['E', 'E'],
    ['F', 'F'],
    ['G', 'G'],
    ['H', 'H'],
    ['I', 'I'],
    ['J', 'J'],
    ['K', 'K'],
    ['L', 'L'],
    ['M', 'M'],
    ['N', 'N'],
    ['O', 'O'],
    ['P', 'P'],
    ['Q', 'Q'],
    ['R', 'R'],
    ['S', 'S'],
    ['T', 'T'],

];



function generateOptions(options) {
    return options.map(option => `<option value="${option[0]}">${option[1]}</option>`).join('');
}


// Update Section value for a specific entry
function updateSectionValue(entryCheck) {
    const section1 = document.getElementById(`section1_${entryCheck}`).value;
    const section2 = document.getElementById(`section2_${entryCheck}`).value;
    document.getElementById(`Section_${entryCheck}`).value = section1 && section2 ? `${section1}-${section2}` : '';
}

// Check amount for a specific entry
function checkAmountAndTrigger(row, entryCheck) {
    const amountInput = row.querySelector(`#amount_${entryCheck}`);
    if (amountInput.value) {
        const shelfValue = document.getElementById(`Shelf_${entryCheck}`).value;
        const trayValue = document.getElementById(`Tray_${entryCheck}`).value;
        const sectionValue = document.getElementById(`Section_${entryCheck}`).value;
        shelf_moistureForm('Test', 'myForm', row, shelfValue, trayValue, sectionValue, '1st Floor', entryCheck);
    }
}


async function submitForm(tableId, mainFormId, formNumber, entryCheck) {
    try {
        const formId = `form_${formNumber}_${entryCheck}`;
        const form = document.getElementById(formId);
        
        if (!form) {
            throw new Error(`Form with ID "${formId}" not found`);
        }

        const formData = new FormData(form);
        formData.delete('csrfmiddlewaretoken');

        // Ensure entry matches the passed entryCheck value
        const entryValue = entryCheck || formData.get('entry');
        if (!entryValue) {
            throw new Error('Entry value is required');
        }

        // Get station value (assuming it's available in your form)
        const stationValue = document.getElementById('id_STATION')?.value || '';

        // Prepare data object with all form values
        const shelfData = {
            ...Object.fromEntries(formData.entries()),
            entry: entryValue,
            station: stationValue,
            // Add floor if available in form
            floor: formData.get('floor') || ''
        };

        // Save to IndexedDB
        const db = await openIndexedDB('GCNA', 2);
        const transaction = db.transaction(['Shelves'], 'readwrite');
        
        // Save to In-House-Drying
        // const dryingStore = transaction.objectStore('In-House-Drying');
        // shelfData.id = await getNextId(dryingStore);
        // await putData(dryingStore, shelfData);

        // Save to Shelves
        const shelvesStore = transaction.objectStore('Shelves');
        shelfData.id = await getNextId(shelvesStore);
        await putData(shelvesStore, shelfData);

        console.log('Shelf data saved successfully', shelfData);
        transferIndexedDBData(); // Transfer to Django

    } catch (error) {
        console.error('Error in submitForm:', error);
    }
}

// Helper functions (make sure these are defined)
async function openIndexedDB(name, version) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(name, version);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject('Error opening DB');
    });
}

async function getNextId(store) {
    return new Promise((resolve) => {
        const req = store.openCursor(null, 'prev');
        req.onsuccess = (e) => {
            const cursor = e.target.result;
            resolve(cursor ? cursor.key + 1 : 1);
        };
    });
}

async function putData(store, data) {
    return new Promise((resolve, reject) => {
        const req = store.put(data);
        req.onsuccess = () => resolve();
        req.onerror = () => reject('Error saving data');
    });
}

</script>

<script>

var formCount = 0;

document.addEventListener("DOMContentLoaded", function () {
    let openRequest3 = indexedDB.open("GCNA");

    openRequest3.onsuccess = function (event) {
        let db = event.target.result;
        let transaction = db.transaction("M_Shelves", "readonly");
        let landInfoStore = transaction.objectStore("M_Shelves");
        let getAllRequest = landInfoStore.getAll();

        getAllRequest.onsuccess = function (event) {
            let landInfoRecords = event.target.result;
            
            // Find all entryCheck elements (both visible and hidden)
            document.querySelectorAll('[id="entryCheck"], [id^="newentryCheck"]').forEach(entryCheckTd => {
                let entryValue = entryCheckTd.textContent.trim();
                let matchingRecords = landInfoRecords.filter(record => record.entry === entryValue);
                
                if (matchingRecords.length > 0) {
                    // Find the container where we should add moisture data
                    let container = entryCheckTd.closest('form').querySelector('#landInfoData2');
                    if (!container) {
                        // If landInfoData2 doesn't exist, create it after the moisture button
                        let moistureBtn = entryCheckTd.closest('form').querySelector('[id^="moisturebtn"]');
                        if (moistureBtn) {
                            container = document.createElement('div');
                            container.id = 'landInfoData2';
                            moistureBtn.parentNode.insertBefore(container, moistureBtn.nextSibling);
                        }
                    }
                    
                    if (container) {
                        // Clear previous content to avoid duplicates
                        container.innerHTML = '';
                        
                        matchingRecords.forEach(record => {
                            let entryContainer = document.createElement("div");
                            entryContainer.className = "entry-container";
                            entryContainer.innerHTML = `
                                <table class="table">
                                    <h5 class="card-title">${record.floor || ''}</h5>
                                    <thead>
                                        <tr>
                                            <th scope="col">Shelf</th>
                                            <th scope="col">Tray</th>
                                            <th scope="col">Section</th>
                                            <th scope="col">Moisture</th>
                                            <th scope="col">Week</th>
                                            <th scope="col">Date</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="original-entry">
                                            <td><input type="text" class="form-control" value="${record.M_Shelf || ''}" required></td>
                                            <td><input type="text" class="form-control" value="${record.M_Tray || ''}" required></td>
                                            <td><input type="text" class="form-control" value="${record.M_Section || ''}" required></td>
                                            <td><input type="text" class="form-control" value="${record.Moisture || ''}" required></td>
                                            <td><input type="text" class="form-control" value="${record.Week || ''}" required></td>
                                            <td><input type="date" class="form-control" value="${record.Date || ''}" required></td>
                                            <td>
                                                <button onclick="duplicateEntry(this, '${record.M_Shelf || ''}', '${record.M_Tray || ''}', '${record.M_Section || ''}', '${record.entry || ''}', '${record.floor || ''}')">Add Moisture Week</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <br><br><br>`;
                            container.appendChild(entryContainer);
                        });
                    }
                }
            });
        };
        
        getAllRequest.onerror = function(event) {
            console.error("Error fetching records from M_Shelves:", event.target.error);
        };
    };
    
    openRequest3.onerror = function(event) {
        console.error("Error opening IndexedDB:", event.target.error);
    };
});





  
  
  function duplicateEntry(button, shelf, tray, section, entry, labelText) {
      formCount++;
      var currentDate = new Date().toISOString().split('T')[0];
  
      var duplicateRow = `
      <tr class="duplicate-entry">
          <td><input type="text" class="form-control" name="M_Shelf" value="${shelf}" required></td>
          <td><input type="text" class="form-control" name="M_Tray" value="${tray}" required></td>
          <td><input type="text" class="form-control" name="M_Section" value="${section}" required></td>
          <td><input type="text" class="form-control" name="Moisture" value="" required></td>
          <td><input type="text" class="form-control" name="Week" value="" required></td>
          <td><input type="date" class="form-control" name="Date" value="${currentDate}" required></td>
          <td>
              <button type="button" class="submit_contents" onclick="submitDuplicateForm(this, '${shelf}', '${tray}', '${section}', '${entry}', '${labelText}')">✔</button>
              <button type="button" class="addrow" onclick="removeForm(this)">Close</button>
          </td>
      </tr>`;
  
      let originalRow = button.closest("tr");
      originalRow.insertAdjacentHTML("afterend", duplicateRow);
  }
  
  function removeForm(button) {
      button.closest("tr").remove();
  }
  
  function submitDuplicateForm(button, shelf, tray, section, entry, labelText) {
      let row = button.closest("tr");
      let formData = {
          M_Shelf: row.querySelector('input[name="M_Shelf"]').value,
          M_Tray: row.querySelector('input[name="M_Tray"]').value,
          M_Section: row.querySelector('input[name="M_Section"]').value,
          Moisture: row.querySelector('input[name="Moisture"]').value,
          Week: row.querySelector('input[name="Week"]').value,
          Date: row.querySelector('input[name="Date"]').value,
          entry: entry,
          floor: labelText
      };
  
      let request = indexedDB.open("GCNA", 2);
  
      request.onsuccess = function (event) {
          let db = event.target.result;
          let transaction = db.transaction("M_Shelves", "readwrite");
          let objectStore = transaction.objectStore("M_Shelves");
  
          let highestIdRequest = objectStore.openCursor(null, "prev");
          highestIdRequest.onsuccess = function (event) {
              let cursor = event.target.result;
              if (cursor) {
                  formData.id = cursor.key + 1;
              } else {
                  formData.id = 1; // First entry
              }
  
              let addRequest = objectStore.add(formData);
  
              addRequest.onsuccess = function () {
                  console.log("Duplicate entry added to IndexedDB successfully");
                  alert("Duplicate entry saved successfully!");
              };
  
              addRequest.onerror = function () {
                  console.error("Error adding duplicate entry to IndexedDB");
              };
          };
      };
  
      request.onerror = function (event) {
          console.error("Error opening IndexedDB", event);
      };
  }
  </script>



  {% endblock %}
</body>
