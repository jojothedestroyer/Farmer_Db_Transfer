{% extends 'gcna/base.html' %} {% block content%}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* General Styles */
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7; /* Adjusted background color */
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .card {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .card-body {
      padding: 20px;
    }

    h4 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th,
    td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      font-weight: bold;
      color: #555;
    }

    td {
      color: #777;
    }

    button {
      cursor: pointer;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: #fff;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    /* Form Styles */
    form {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 16px;
      color: #333;
      outline: none;
    }

    #saveButton,
    #closeButton {
      margin-top: 10px;
      background-color: #28a745;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #closeButton {
      background-color: #dc3545;
      margin-left: 10px;
    }

    /* Responsive Styles */
    @media screen and (max-width: 768px) {
      .container {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="landInfoData"></div>
                                         <a href="/table/" class="btn btn-secondary">Return</a>

  </div>



  <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, set, get, query, orderByChild, equalTo, update, push,remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBZTB_mN_gIb6mqeM8nid4x83oKRehmFKo",
    authDomain: "farmer-project-sync.firebaseapp.com",
    databaseURL: "https://farmer-project-sync-default-rtdb.firebaseio.com",
    projectId: "farmer-project-sync",
    storageBucket: "farmer-project-sync.firebasestorage.app",
    messagingSenderId: "1366353203",
    appId: "1:1366353203:web:fa29fd29cc326a0d63ca46"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  async function deleteRecord(id) {
    if (!confirm("Delete this record?")) return;

    const tableName = "Mace_Purchase";
    const userId = localStorage.getItem("customUserId");

    try {
  
      if (navigator.onLine && userId) {
        await remove(ref(db, `Users/${userId}/models/${tableName}/${id}`));
      }
deleteIndexeddb(id)
      
    } catch (error) {
      console.error("Delete failed:", error);
    }
  }

  window.deleteRecord = deleteRecord;

  function deleteIndexeddb(id) {
    let openRequest = indexedDB.open("GCNA");

    openRequest.onsuccess = function (event) {
      let db = event.target.result;
      let transaction = db.transaction("Mace_Purchase", "readwrite");
      let store = transaction.objectStore("Mace_Purchase");

      let deleteRequest = store.delete(id);

      deleteRequest.onsuccess = function () {
        console.log(`Record ${id} deleted successfully.`);
        const element = document.getElementById(`entryContainer_${id}`);
        if (element) {
          element.remove();
        }
      };

      deleteRequest.onerror = function () {
        console.error("Error deleting record:", deleteRequest.error);
        alert("Failed to delete record.");
      };
    };
  
}

</script>
  <script>

function toggleRecord(id) {
  const details = document.getElementById(`recordDetails-${id}`);

  if (details.style.display === "none") {
    details.style.display = "block";
  } else {
    details.style.display = "none";
  }
}



    let openRequest = indexedDB.open("GCNA");
    let fieldBlacklist = [];
    const fieldBlacklistConfig = {
      DATE_OF_SAMPLING: true, // Set to true to blacklist if null or empty
      DECISION: true,
      Quantity_of_Bags: true,

      // Add more fields as needed
    };

    openRequest.onsuccess = function (event) {
      let db = event.target.result;
      let transaction = db.transaction("Mace_Purchase", "readonly");
      let landInfoStore = transaction.objectStore("Mace_Purchase");
      let getAllRequest = landInfoStore.getAll();

      getAllRequest.onsuccess = function (event) {
        let landInfoRecords = event.target.result;
        let landInfoDataDiv = document.getElementById("landInfoData");

        landInfoRecords.forEach((record) => {
         if (
            record.COMPLETE == "Yes" ||
            record.COMPLETE == "Y" ||
            record.COMPLETE == "y" ||
            record.COMPLETE == "yes"
          ) {
            return;
          }


let entryContainer = document.createElement("div");
entryContainer.id = `entryContainer_${record.id}`;
entryContainer.className = "record-container";
let labelText = record.BATCH_CODE_M1 !== ""
  ? (`Mace Batches: M1:${record.BATCH_CODE_M1}    M2:${record.BATCH_CODE_M2}      M3:${record.BATCH_CODE_M3}`)
  : record.BATCH_CODE_M1 ;

// entryContainer.innerHTML = `
//   <button class="btn btn-primary" 
//           onclick="toggleRecord(${record.id})" 
//           style="width:100%; text-align:left; margin-bottom:8px;">
//     ${labelText} 
//   </button>

//   <div id="recordDetails-${record.id}" style="display:none;"> 
//               <form id="form_${record.id}">
//                     <div class="card-body">
                  
//                     </h5>
//                       <p class="card-text">
//                           <table id="vertical-1" class="table table-hover table-light">
                         
           
entryContainer.innerHTML = `


<div class="d-flex gap-2" style="margin-bottom:8px;">
    <button class="btn btn-primary" 
            onclick="toggleRecord(${record.id})" 
            style="flex-grow: 1; text-align:left;">
      ${labelText} 
    </button>
    <button class="btn btn-danger" 
            onclick="deleteRecord(${record.id})" 
            title="Delete Record">
      &times;
    </button>
  </div>

  

  <div id="recordDetails-${record.id}" style="display:none;"> 
      <form>
      <div class="card">
        <div class="card-body">
        <p class="card-text">

        <table id="vertical-1" class="table table-hover table-light">

        <tr>
            <th>STATION</th>
                                 <td>       <input type="text" class="form-control" name="STATION" value="${record.STATION || ''}" /> </td>

        </tr>
    <tr>
            <th>DATE OF PURCHASE</th>
                                               <td>     <input type="date" class="form-control" name="DATE_OF_PURCHASE" value="${record.DATE_OF_PURCHASE || ''}" /> </td>

        </tr>

        <tr>
          <th>PLACE OF PURCHASE</th>
                                              <td>    <input type="text" class="form-control" name="PLACE_OF_PURCHASE" value="${record.PLACE_OF_PURCHASE || ''}" /> </td>

      </tr>

        <tr>
            <th>TOTAL # OF FARMERS</th>
                                                   <td> <input type="number" class="form-control" name="TOTAL_NUM_OF_FARMERS" value="${record.TOTAL_NUM_OF_FARMERS || ''}" /> </td>

        </tr>
    <tr>
            <th>TOTAL LBS Mace BOUGHT</th>
                                                   <td> <input type="number" step="any" class="form-control" name="TOTAL_LBS_NUTMEG_BOUGHT" value="${record.TOTAL_LBS_NUTMEG_BOUGHT || ''}" /> </td>

        </tr>



        <tr>
          <th>Mace1 Batch Code</th>
         
                                                           <td> <input type="text" class="form-control" name="PLACE_OF_PURCHASE" value="${record.BATCH_CODE_M1 || ''}" /> </td>

      </tr>        <tr>
          <th>Mace2 Batch Code</th>
         
                                                          <td>  <input type="text" class="form-control" name="PLACE_OF_PURCHASE" value="${record.BATCH_CODE_M2 || ''}" /> </td>

      </tr>     
         <tr>
          <th>Mace3 Batch Code</th>
         
                                                 <td> <input type="text" class="form-control" name="PLACE_OF_PURCHASE" value="${record.BATCH_CODE_M3 || ''}" /> </td>

      </tr>
      
        <tr>
            <th># OF BAGS</th>
                                                   <td> <input type="number" " class="form-control" name="NUM_OF_BAGS" value="${record.NUM_OF_BAGS || ''}" /> </td>

        </tr>

        <tr>
            <th>Quantity of Mace 1</th>
                                                   <td> <input type="number" step="any" class="form-control" name="MACE_1" value="${record.MACE_1 || ''}" /> </td>

        </tr>

        <tr>
            <th>Quantity of Mace 2</th>
                                                   <td> <input type="number" step="any" class="form-control" name="MACE_2" value="${record.MACE_2 || ''}" /> </td>

        </tr>


        <tr>
            <th>Quantity of Mace 3</th>
                                                                <td><input type="number" step="any" class="form-control" name="MACE_3" value="${record.MACE_3 || ''}" /> </td>


        </tr>


       
                  
                          <tr>
                        <th>Actions</th>
                        <td>
                          <button type="button" class="save-btn" onclick="saveEditedRecord(${record.id})">Save Changes</button>
                          <button type="button" onclick="saveEditedCompletion(${record.id}, 'Yes')">Mark as Complete</button>
                        </td>
                      </tr>  
                      </table>
                      
                     </div>
                 </div>
                 <br> <br> <br>
                 
             `;
          landInfoDataDiv.appendChild(entryContainer);
        });
      };
    };



    function saveEditedRecord(id) {
      let form = document.getElementById(`form_${id}`);
      let formData = new FormData(form);
      let openRequestup = indexedDB.open("GCNA");

      openRequestup.onsuccess = function (event) {
        let db1 = event.target.result;
        let transaction = db1.transaction("Mace_Purchase", "readwrite");
        let maceInfoStore = transaction.objectStore("Mace_Purchase");
        let getRequest = maceInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;
          
          // Update record with form values
          for (let [key, value] of formData.entries()) {
            record[key] = value;
          }

          let updateRequest = maceInfoStore.put(record);
          updateRequest.onsuccess = function () {
            alert("Record updated successfully!");
          };
          
          updateRequest.onerror = function(event) {
            console.error("Error updating record:", event.target.error);
            alert("Error updating record. Please try again.");
          };
        };
      };
    }

    function saveEditedCompletion(id, completion) {
      let openRequestup = indexedDB.open("GCNA");

      openRequestup.onsuccess = function (event) {
        let db1 = event.target.result;
        let transaction = db1.transaction("Mace_Purchase", "readwrite");
        let maceInfoStore = transaction.objectStore("Mace_Purchase");
        let getRequest = maceInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;
          
          // First save any edited values from the form
          let form = document.getElementById(`form_${id}`);
          let formData = new FormData(form);
          
          // Update record with form values
          for (let [key, value] of formData.entries()) {
            record[key] = value;
          }
          
          // Then mark as complete
          record.COMPLETE = completion;

          let updateRequest = maceInfoStore.put(record);
          updateRequest.onsuccess = function () {
            alert("Entry marked as complete!");
            // Remove the entry from the display
            let entryContainer = document.getElementById(`entryContainer_${id}`);
            if (entryContainer) {
              entryContainer.remove();
            }
window.location.reload();
          };
        };
      };
    }

    
    function saveEditedCompletion2(id, completion) {
      let openRequestup = indexedDB.open("GCNA");

      openRequestup.onsuccess = function (event) {
        let db1 = event.target.result;
        let transaction = db1.transaction("Mace_Purchase", "readwrite");
        let landInfoStore = transaction.objectStore("Mace_Purchase");
        let getRequest = landInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;
          record.COMPLETE = completion;

          let updateRequest = landInfoStore.put(record);
          updateRequest.onsuccess = function () {
            console.log("Mace Date updated successfully!");
          };
        };
      };
    };


    function deleteEntry(id) {
      let openRequest = indexedDB.open("GCNA");

      openRequest.onsuccess = function (event) {
        let db = event.target.result;
        let transaction = db.transaction("Mace_Purchase", "readwrite");
        let landInfoStore = transaction.objectStore("Mace_Purchase");

        // Get the record to be deleted
        let getRequest = landInfoStore.get(id);

        getRequest.onsuccess = function (event) {
          let record = event.target.result;

          // Now, let's open the DELETED database and add the record there
          let openDeletedRequest = indexedDB.open("DELETED");

          openDeletedRequest.onsuccess = function (event) {
            let deletedDB = event.target.result;
            let deletedTransaction = deletedDB.transaction(
              "Mace_Purchase",
              "readwrite"
            );
            let deletedStore = deletedTransaction.objectStore("Mace_Purchase");

            // Add the record to the DELETED database
            let addRequest = deletedStore.add(record);

            addRequest.onsuccess = function () {
              console.log(`Record with ID ${id} copied to DELETED database.`);
            };

            addRequest.onerror = function () {
              console.log(
                `Failed to copy record with ID ${id} to DELETED database.`
              );
            };
          };

          openDeletedRequest.onerror = function () {
            console.log("Failed to open DELETED database.");
          };
        };

        // Now, proceed with deleting the record from the original database
        let deleteRequest = landInfoStore.delete(id);

        deleteRequest.onsuccess = function () {
          console.log(`Record with ID ${id} deleted from GCNA database.`);
          // You might want to refresh your display here.
        };

        deleteRequest.onerror = function () {
          console.log(
            `Failed to delete record with ID ${id} from GCNA database.`
          );
        };
      };

      openRequest.onerror = function () {
        console.log("Failed to open GCNA database.");
      };
    }
 
 
 </script>

  {% endblock %}
</body>
